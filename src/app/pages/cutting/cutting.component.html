<div class="cutting-container">
  <!-- ============================================ -->
  <!-- TOAST NOTIFICATIONS CONTAINER -->
  <!-- ============================================ -->
  <div class="toast-container" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'">
    <div
      *ngFor="let toast of toasts"
      class="toast"
      [class.toast-success]="toast.type === 'success'"
      [class.toast-error]="toast.type === 'error'"
      [class.toast-info]="toast.type === 'info'"
      [class.toast-warning]="toast.type === 'warning'">

      <div class="toast-icon">
        <i class="bi"
           [ngClass]="{
             'bi-check-circle-fill': toast.type === 'success',
             'bi-x-circle-fill': toast.type === 'error',
             'bi-info-circle-fill': toast.type === 'info',
             'bi-exclamation-triangle-fill': toast.type === 'warning'
           }"></i>
      </div>

      <div class="toast-content">
        <p class="toast-message">{{ toast.message }}</p>
      </div>

      <button class="toast-close" (click)="removeToast(toast.id)">
        <i class="bi bi-x"></i>
      </button>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- LIST VIEW -->
  <!-- ============================================ -->
  <div *ngIf="currentView === 'list'" class="list-view">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-left">
          <h1 class="page-title">
            <i class="bi bi-scissors"></i>
            {{ formLanguage === 'ar' ? 'إدارة القص بالليزر' : 'Laser Cutting Management' }}
          </h1>
          <p class="page-subtitle">{{ formLanguage === 'ar' ? 'إضافة وتعديل ومتابعة مهام القص بالليزر' : 'Add, edit and track laser cutting jobs' }}</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="openTrackingView()">
            <i class="bi bi-clipboard-check"></i>
            {{ formLanguage === 'ar' ? 'متابعة عمليات القص' : 'Track Cutting' }}
          </button>
          <button class="btn btn-primary" (click)="createNewJob()">
            <i class="bi bi-plus-lg"></i>
            {{ formLanguage === 'ar' ? 'إنشاء مهمة جديدة' : 'Create New Job' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="statistics-bar" *ngIf="statistics && !loadingStatistics">
      <div class="stat-item">
        <i class="bi bi-briefcase-fill"></i>
        <div>
          <span class="stat-value">{{ statistics.total }}</span>
          <span class="stat-label">{{ formLanguage === 'ar' ? 'إجمالي المهام' : 'Total Jobs' }}</span>
        </div>
      </div>

      <div class="stat-item">
        <i class="bi bi-hourglass-split"></i>
        <div>
          <span class="stat-value">{{ statistics.byStatus['معلق'] || 0 }}</span>
          <span class="stat-label">{{ formLanguage === 'ar' ? 'معلق' : 'Pending' }}</span>
        </div>
      </div>

      <div class="stat-item">
        <i class="bi bi-arrow-repeat"></i>
        <div>
          <span class="stat-value">{{ statistics.byStatus['قيد التنفيذ'] || 0 }}</span>
          <span class="stat-label">{{ formLanguage === 'ar' ? 'قيد التنفيذ' : 'In Progress' }}</span>
        </div>
      </div>

      <div class="stat-item">
        <i class="bi bi-check-circle-fill"></i>
        <div>
          <span class="stat-value">{{ statistics.byStatus['مكتمل'] || 0 }}</span>
          <span class="stat-label">{{ formLanguage === 'ar' ? 'مكتمل' : 'Completed' }}</span>
        </div>
      </div>
    </div>

    <!-- Filters and Search -->
    <div class="filters-section">
      <div class="filters-grid">
        <!-- Search -->
        <div class="filter-group search-group">
          <label class="filter-label">
            <i class="bi bi-search"></i>
            {{ formLanguage === 'ar' ? 'البحث' : 'Search' }}
          </label>
          <input
            type="text"
            class="filter-input"
            [placeholder]="formLanguage === 'ar' ? 'ابحث برقم المهمة، اسم المشروع، اسم القطعة...' : 'Search by job ID, project name, piece name...'"
            [(ngModel)]="searchTerm"
            (input)="onSearchChange()"
          />
        </div>

        <!-- Status Filter -->
        <div class="filter-group">
          <label class="filter-label">
            <i class="bi bi-flag"></i>
            {{ formLanguage === 'ar' ? 'الحالة' : 'Status' }}
          </label>
          <select
            class="filter-select"
            [(ngModel)]="selectedStatus"
            (change)="onFilterChange()">
            <option value="">{{ formLanguage === 'ar' ? 'جميع الحالات' : 'All Statuses' }}</option>
            <option value="معلق">{{ formLanguage === 'ar' ? 'معلق' : 'Pending' }}</option>
            <option value="قيد التنفيذ">{{ formLanguage === 'ar' ? 'قيد التنفيذ' : 'In Progress' }}</option>
            <option value="مكتمل">{{ formLanguage === 'ar' ? 'مكتمل' : 'Completed' }}</option>
            <option value="جزئي">{{ formLanguage === 'ar' ? 'جزئي' : 'Partial' }}</option>
          </select>
        </div>

        <!-- Material Filter -->
        <div class="filter-group">
          <label class="filter-label">
            <i class="bi bi-layers"></i>
            {{ formLanguage === 'ar' ? 'نوع المادة' : 'Material' }}
          </label>
          <select
            class="filter-select"
            [(ngModel)]="selectedMaterialType"
            (change)="onFilterChange()">
            <option value="">{{ formLanguage === 'ar' ? 'جميع المواد' : 'All Materials' }}</option>
            <option *ngFor="let material of materialTypes" [value]="material.value">
              {{ formLanguage === 'ar' ? material.label : material.labelEn }}
            </option>
          </select>
        </div>

        <!-- Clear Filters -->
        <div class="filter-group">
          <label class="filter-label">&nbsp;</label>
          <button class="btn btn-secondary" (click)="clearFilters()" *ngIf="selectedStatus || selectedMaterialType || searchTerm">
            <i class="bi bi-x-circle"></i>
            {{ formLanguage === 'ar' ? 'مسح الفلاتر' : 'Clear Filters' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <!-- Loading State -->
      <div class="loading-overlay" *ngIf="loading">
        <div class="spinner">
          <i class="bi bi-arrow-clockwise spin"></i>
        </div>
        <p>{{ formLanguage === 'ar' ? 'جاري التحميل...' : 'Loading...' }}</p>
      </div>

      <!-- Cutting Jobs Table -->
      <table class="cutting-table">
        <thead>
          <tr>
            <th>{{ formLanguage === 'ar' ? 'رقم المهمة' : 'Job ID' }}</th>
            <th>{{ formLanguage === 'ar' ? 'المشروع والقطعة' : 'Project & Piece' }}</th>
            <th>{{ formLanguage === 'ar' ? 'المادة والسماكة' : 'Material & Thickness' }}</th>
            <th>{{ formLanguage === 'ar' ? 'الكمية' : 'Quantity' }}</th>
            <th>{{ formLanguage === 'ar' ? 'التقدم' : 'Progress' }}</th>
            <th>{{ formLanguage === 'ar' ? 'الحالة' : 'Status' }}</th>
            <th>{{ formLanguage === 'ar' ? 'تاريخ الإنشاء' : 'Created Date' }}</th>
            <th>{{ formLanguage === 'ar' ? 'الإجراءات' : 'Actions' }}</th>
          </tr>
        </thead>

        <tbody *ngIf="!loading && cuttingJobs.length > 0">
          <tr *ngFor="let job of cuttingJobs">
            <!-- Job ID -->
            <td>
              <span class="job-id-badge">{{ job.id }}</span>
            </td>

            <!-- Project & Piece -->
            <td>
              <div class="project-cell">
                <span class="project-name">{{ job.projectName }}</span>
                <span class="piece-name" *ngIf="job.pieceName">{{ job.pieceName }}</span>
              </div>
            </td>

            <!-- Material & Thickness -->
            <td>
              <div class="material-cell">
                <span class="material-badge">{{ getMaterialTypeLabel(job.materialType) }}</span>
                <span class="thickness-text">{{ job.thickness }} {{ formLanguage === 'ar' ? 'مم' : 'mm' }}</span>
              </div>
            </td>

            <!-- Quantity -->
            <td>
              <div class="quantity-cell">
                <span class="quantity-badge">{{ job.quantity }}</span>
              </div>
            </td>

            <!-- Progress -->
            <td>
              <div class="progress-cell">
                <div class="progress-info">
                  <span class="progress-text">{{ job.currentlyCut || 0 }} / {{ job.quantity }}</span>
                  <span class="progress-percentage">{{ calculateProgress(job) }}%</span>
                </div>
                <div class="mini-progress-bar">
                  <div class="mini-progress-fill"
                       [style.width.%]="calculateProgress(job)"
                       [style.background]="getProgressColor(calculateProgress(job))">
                  </div>
                </div>
              </div>
            </td>

            <!-- Status -->
            <td>
              <span class="status-badge" [ngClass]="getStatusColor(job.fileStatus)">
                {{ getStatusLabel(job.fileStatus) }}
              </span>
            </td>

            <!-- Created Date -->
            <td>
              <span class="date-text">{{ formatDate(job.createdAt) }}</span>
            </td>

            <!-- Actions Dropdown Menu -->
            <td>
              <div class="actions-dropdown">
                <button
                  class="actions-trigger"
                  type="button"
                  [attr.data-job-id]="job.id"
                  (click)="toggleActionsMenu(job.id, $event)"
                >
                  <i class="bi bi-three-dots-vertical"></i>
                </button>

                <div
                  class="actions-menu"
                  [ngClass]="{ 'open-upward': menuShouldOpenUp[job.id] }"
                  *ngIf="activeActionsMenu === job.id"
                >
                  <button type="button" class="action-menu-item" (click)="openTrackingViewForJob(job); closeActionsMenu(); $event.stopPropagation()">
                    <i class="bi bi-clipboard-check"></i>
                    <span>{{ formLanguage === 'ar' ? 'متابعة القص' : 'Track Cutting' }}</span>
                  </button>

                  <button type="button" class="action-menu-item" (click)="openUserHistoryModal(job); closeActionsMenu(); $event.stopPropagation()">
                    <i class="bi bi-clock-history"></i>
                    <span>{{ formLanguage === 'ar' ? 'سجل المستخدمين' : 'User History' }}</span>
                  </button>

                  <button type="button" class="action-menu-item" (click)="openViewModal(job); closeActionsMenu(); $event.stopPropagation()">
                    <i class="bi bi-eye"></i>
                    <span>{{ formLanguage === 'ar' ? 'عرض التفاصيل' : 'View Details' }}</span>
                  </button>

                  <button type="button" class="action-menu-item" (click)="downloadFile(job.id, job.fileName); closeActionsMenu(); $event.stopPropagation()" *ngIf="job.fileName">
                    <i class="bi bi-download"></i>
                    <span>{{ formLanguage === 'ar' ? 'تحميل الملف' : 'Download File' }}</span>
                  </button>

                  <button type="button" class="action-menu-item" (click)="openDuplicateModal(job); closeActionsMenu(); $event.stopPropagation()">
                    <i class="bi bi-files"></i>
                    <span>{{ formLanguage === 'ar' ? 'نسخ وإعادة استخدام' : 'Duplicate & Reuse' }}</span>
                  </button>

                  <button type="button" class="action-menu-item" (click)="openEditModal(job); closeActionsMenu(); $event.stopPropagation()">
                    <i class="bi bi-pencil"></i>
                    <span>{{ formLanguage === 'ar' ? 'تعديل' : 'Edit' }}</span>
                  </button>

                  <div class="menu-divider"></div>

                  <button type="button" class="action-menu-item danger" (click)="openDeleteModal(job); closeActionsMenu(); $event.stopPropagation()">
                    <i class="bi bi-trash"></i>
                    <span>{{ formLanguage === 'ar' ? 'حذف' : 'Delete' }}</span>
                  </button>
                </div>
              </div>
            </td>
          </tr>
        </tbody>

        <tbody *ngIf="loading">
          <tr>
            <td colspan="8" class="loading-cell">
              <i class="bi bi-arrow-clockwise spin"></i> {{ formLanguage === 'ar' ? 'جاري التحميل...' : 'Loading...' }}
            </td>
          </tr>
        </tbody>

        <tbody *ngIf="!loading && cuttingJobs.length === 0">
          <tr>
            <td colspan="8" class="empty-cell">
              {{ formLanguage === 'ar' ? 'لا توجد مهام قص' : 'No cutting jobs found' }}
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination" *ngIf="!loading && totalPages > 1">
        <button
          class="btn-page"
          [disabled]="currentPage === 1"
          (click)="previousPage()">
          <i class="bi" [ngClass]="formLanguage === 'ar' ? 'bi-chevron-right' : 'bi-chevron-left'"></i>
        </button>

        <span class="page-info">
          {{ formLanguage === 'ar' ? 'صفحة' : 'Page' }} {{ currentPage }} {{ formLanguage === 'ar' ? 'من' : 'of' }} {{ totalPages }}
        </span>

        <button
          class="btn-page"
          [disabled]="currentPage === totalPages"
          (click)="nextPage()">
          <i class="bi" [ngClass]="formLanguage === 'ar' ? 'bi-chevron-left' : 'bi-chevron-right'"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- CREATE VIEW -->
  <!-- ============================================ -->
  <div *ngIf="currentView === 'create'" class="form-view" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-left">
          <h1 class="page-title">
            <i class="bi bi-plus-circle"></i>
            {{ formLanguage === 'ar' ? 'إنشاء مهمة قص جديدة' : 'Create New Cutting Job' }}
          </h1>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="backToList()">
            {{ formLanguage === 'ar' ? 'إلغاء' : 'Cancel' }}
          </button>
          <button
            class="btn btn-primary"
            (click)="saveJob()"
            [disabled]="creatingJob">
            <i class="bi" [ngClass]="creatingJob ? 'bi-arrow-clockwise spin' : 'bi-check-lg'"></i>
            {{ creatingJob
              ? (formLanguage === 'ar' ? 'جاري الحفظ...' : 'Saving...')
              : (formLanguage === 'ar' ? 'حفظ' : 'Save')
            }}
          </button>
        </div>
      </div>
    </div>

    <!-- Error Alert -->
    <div class="alert alert-error" *ngIf="formError">
      <i class="bi bi-exclamation-circle-fill"></i>
      <span>{{ formError }}</span>
    </div>

    <!-- Form Content -->
    <div class="form-content">
      <!-- Project Information -->
      <div class="form-section">
        <h2 class="section-title">
          {{ formLanguage === 'ar' ? 'معلومات المشروع' : 'Project Information' }}
        </h2>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-folder"></i>
              {{ formLanguage === 'ar' ? 'اسم المشروع' : 'Project Name' }}
            </label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="formData.projectName"
              [class.error]="fieldErrors['projectName']"
              [placeholder]="formLanguage === 'ar' ? 'أدخل اسم المشروع' : 'Enter project name'"
            />
            <small class="error-message" *ngIf="fieldErrors['projectName']">
              <i class="bi bi-exclamation-circle"></i>
              {{ fieldErrors['projectName'] }}
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-puzzle"></i>
              {{ formLanguage === 'ar' ? 'اسم القطعة' : 'Piece Name' }}
            </label>
            <input
              type="text"
              class="form-input"
              [(ngModel)]="formData.pieceName"
              [placeholder]="formLanguage === 'ar' ? 'أدخل اسم القطعة (اختياري)' : 'Enter piece name (optional)'"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-hash"></i>
              {{ formLanguage === 'ar' ? 'الكمية' : 'Quantity' }}
            </label>
            <input
              type="number"
              class="form-input"
              [(ngModel)]="formData.quantity"
              [class.error]="fieldErrors['quantity']"
              min="1"
              [placeholder]="formLanguage === 'ar' ? 'أدخل الكمية' : 'Enter quantity'"
            />
            <small class="error-message" *ngIf="fieldErrors['quantity']">
              <i class="bi bi-exclamation-circle"></i>
              {{ fieldErrors['quantity'] }}
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-rulers"></i>
              {{ formLanguage === 'ar' ? 'السماكة (مم)' : 'Thickness (mm)' }}
            </label>
            <input
              type="number"
              class="form-input"
              [(ngModel)]="formData.thickness"
              [class.error]="fieldErrors['thickness']"
              min="0"
              step="0.1"
              [placeholder]="formLanguage === 'ar' ? 'أدخل السماكة' : 'Enter thickness'"
            />
            <small class="error-message" *ngIf="fieldErrors['thickness']">
              <i class="bi bi-exclamation-circle"></i>
              {{ fieldErrors['thickness'] }}
            </small>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="bi bi-layers"></i>
            {{ formLanguage === 'ar' ? 'نوع المادة' : 'Material Type' }}
          </label>
          <select
            class="form-select"
            [(ngModel)]="formData.materialType"
            [class.error]="fieldErrors['materialType']">
            <option value="">{{ formLanguage === 'ar' ? '-- اختر نوع المادة --' : '-- Select Material Type --' }}</option>
            <option *ngFor="let material of materialTypes" [value]="material.value">
              {{ formLanguage === 'ar' ? material.label : material.labelEn }}
            </option>
          </select>
          <small class="error-message" *ngIf="fieldErrors['materialType']">
            <i class="bi bi-exclamation-circle"></i>
            {{ fieldErrors['materialType'] }}
          </small>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="bi bi-chat-text"></i>
            {{ formLanguage === 'ar' ? 'ملاحظات' : 'Notes' }}
          </label>
          <textarea
            class="form-input"
            [(ngModel)]="formData.notes"
            rows="3"
            [placeholder]="formLanguage === 'ar' ? 'أدخل أي ملاحظات إضافية (اختياري)' : 'Enter any additional notes (optional)'"
          ></textarea>
        </div>
      </div>

      <!-- File Upload -->
      <div class="form-section">
        <h2 class="section-title">
          {{ formLanguage === 'ar' ? 'رفع الملف' : 'File Upload' }}
        </h2>

        <div class="file-upload-area">
          <input
            type="file"
            id="file-input"
            class="file-input"
            (change)="onFileSelected($event)"
            accept=".dwg,.dxf,.dwt,.nc,.txt"
          />

          <label for="file-input" class="file-upload-label" *ngIf="!selectedFileName">
            <i class="bi bi-cloud-upload"></i>
            <span>{{ formLanguage === 'ar' ? 'انقر لرفع الملف أو اسحب وأفلت' : 'Click to upload or drag and drop' }}</span>
            <small>{{ formLanguage === 'ar' ? 'DWG, DXF, DWT, NC, TXT (الحد الأقصى 50 ميجابايت)' : 'DWG, DXF, DWT, NC, TXT (Max 50MB)' }}</small>
          </label>

          <div class="file-selected" *ngIf="selectedFileName">
            <div class="file-icon">
              <i class="bi" [ngClass]="getFileIcon(selectedFileName)"></i>
            </div>
            <div class="file-details">
              <p class="file-name">{{ selectedFileName }}</p>
              <small class="file-size" *ngIf="selectedFile">
                {{ formatFileSize(selectedFile.size) }}
              </small>
            </div>
            <button type="button" class="btn-remove-file" (click)="removeSelectedFile()">
              <i class="bi bi-x-circle"></i>
            </button>
          </div>

          <small class="error-message" *ngIf="fieldErrors['file']">
            <i class="bi bi-exclamation-circle"></i>
            {{ fieldErrors['file'] }}
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- TRACKING VIEW -->
  <!-- ============================================ -->
  <div *ngIf="currentView === 'track'" class="form-view" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'">
    <!-- Header -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-left">
          <h1 class="page-title">
            <i class="bi bi-clipboard-check"></i>
            {{ formLanguage === 'ar' ? 'متابعة عمليات القص' : 'Track Cutting Operations' }}
          </h1>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="backToList()">
            {{ formLanguage === 'ar' ? 'رجوع' : 'Back' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Tracking Content -->
    <div class="form-content">
      <!-- Job Selection -->
      <div class="form-section">
        <h2 class="section-title">
          {{ formLanguage === 'ar' ? 'اختر مهمة القص' : 'Select Cutting Job' }}
        </h2>

        <div class="form-group">
          <label class="form-label">
            <i class="bi bi-list-check"></i>
            {{ formLanguage === 'ar' ? 'رقم المهمة' : 'Job ID' }}
          </label>
          <select
            class="form-select"
            [(ngModel)]="trackingData.jobId"
            (ngModelChange)="onJobSelected()">
            <option value="">{{ formLanguage === 'ar' ? '-- اختر مهمة قص --' : '-- Select Cutting Job --' }}</option>
            <option *ngFor="let job of cuttingJobs" [value]="job.id">
              {{ job.id }} - {{ job.projectName }} ({{ job.pieceName || (formLanguage === 'ar' ? 'بدون اسم قطعة' : 'No piece name') }})
            </option>
          </select>
        </div>
      </div>

      <!-- Job Details -->
      <div class="form-section" *ngIf="selectedJob">
        <div class="section-header-with-action">
          <h2 class="section-title">
            {{ formLanguage === 'ar' ? 'تفاصيل المهمة' : 'Job Details' }}
          </h2>
          <button
            class="btn btn-secondary btn-download-file"
            *ngIf="selectedJob.fileName && selectedJob.filePath"
            (click)="downloadFile(selectedJob.id, selectedJob.fileName)"
            type="button">
            <i class="bi bi-download"></i>
            {{ formLanguage === 'ar' ? 'تحميل الملف' : 'Download File' }}
          </button>
        </div>

        <div class="job-details-card">
          <div class="detail-row">
            <div class="detail-item">
              <span class="detail-label">{{ formLanguage === 'ar' ? 'اسم المشروع:' : 'Project Name:' }}</span>
              <span class="detail-value">{{ selectedJob.projectName }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ formLanguage === 'ar' ? 'اسم القطعة:' : 'Piece Name:' }}</span>
              <span class="detail-value">{{ selectedJob.pieceName || '-' }}</span>
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-item">
              <span class="detail-label">{{ formLanguage === 'ar' ? 'نوع المادة:' : 'Material Type:' }}</span>
              <span class="detail-value">{{ getMaterialTypeLabel(selectedJob.materialType) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ formLanguage === 'ar' ? 'السماكة:' : 'Thickness:' }}</span>
              <span class="detail-value">{{ selectedJob.thickness }} {{ formLanguage === 'ar' ? 'مم' : 'mm' }}</span>
            </div>
          </div>

          <div class="quantity-tracker">
            <div class="quantity-item quantity-total">
              <i class="bi bi-box"></i>
              <div class="quantity-info">
                <span class="quantity-label">{{ formLanguage === 'ar' ? 'العدد الكلي' : 'Total Quantity' }}</span>
                <span class="quantity-number">{{ selectedJob.quantity }}</span>
              </div>
            </div>

            <div class="quantity-item quantity-cut">
              <i class="bi bi-check2-circle"></i>
              <div class="quantity-info">
                <span class="quantity-label">{{ formLanguage === 'ar' ? 'المقصود حالياً' : 'Currently Cut' }}</span>
                <span class="quantity-number">{{ selectedJob.currentlyCut || 0 }}</span>
              </div>
            </div>

            <div class="quantity-item quantity-remaining">
              <i class="bi bi-hourglass-split"></i>
              <div class="quantity-info">
                <span class="quantity-label">{{ formLanguage === 'ar' ? 'المتبقي' : 'Remaining' }}</span>
                <span class="quantity-number">{{ selectedJob.remaining || selectedJob.quantity }}</span>
              </div>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="progress-section">
            <div class="progress-header">
              <span>{{ formLanguage === 'ar' ? 'التقدم:' : 'Progress:' }}</span>
              <span class="progress-percentage">{{ calculateProgress(selectedJob) }}%</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                [style.width.%]="calculateProgress(selectedJob)"
                [style.background]="getProgressColor(calculateProgress(selectedJob))">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Update Section -->
      <div class="form-section" *ngIf="selectedJob">
        <h2 class="section-title">
          {{ formLanguage === 'ar' ? 'تحديث حالة القص' : 'Update Cutting Status' }}
        </h2>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-scissors"></i>
              {{ formLanguage === 'ar' ? 'العدد الذي تم قصه في هذه الدفعة' : 'Quantity Cut in This Batch' }}
            </label>
            <input
              type="number"
              class="form-input"
              [(ngModel)]="trackingData.currentlyCut"
              min="0"
              [max]="selectedJob.remaining || selectedJob.quantity"
              [placeholder]="formLanguage === 'ar' ? 'أدخل العدد المقصود' : 'Enter cut quantity'"
            />
            <small class="help-text">
              {{ formLanguage === 'ar' ? 'الحد الأقصى:' : 'Maximum:' }} {{ selectedJob.remaining }}
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="bi bi-flag"></i>
              {{ formLanguage === 'ar' ? 'الحالة الجديدة' : 'New Status' }}
            </label>
            <select
              class="form-select"
              [(ngModel)]="trackingData.newStatus">
              <option value="معلق">{{ formLanguage === 'ar' ? 'معلق' : 'Pending' }}</option>
              <option value="قيد التنفيذ">{{ formLanguage === 'ar' ? 'قيد التنفيذ' : 'In Progress' }}</option>
              <option value="مكتمل">{{ formLanguage === 'ar' ? 'مكتمل' : 'Completed' }}</option>
              <option value="جزئي">{{ formLanguage === 'ar' ? 'جزئي' : 'Partial' }}</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="bi bi-chat-text"></i>
            {{ formLanguage === 'ar' ? 'ملاحظات القص' : 'Cutting Notes' }}
          </label>
          <textarea
            class="form-input"
            [(ngModel)]="trackingData.notes"
            rows="3"
            [placeholder]="formLanguage === 'ar' ? 'أدخل أي ملاحظات حول عملية القص (اختياري)' : 'Enter any notes about the cutting process (optional)'"
          ></textarea>
        </div>

        <div class="form-actions-bottom">
          <button
            class="btn btn-primary btn-large"
            (click)="updateTracking()"
            [disabled]="updatingJob">
            <i class="bi" [ngClass]="updatingJob ? 'bi-arrow-clockwise spin' : 'bi-check-circle'"></i>
            {{ updatingJob
              ? (formLanguage === 'ar' ? 'جاري التحديث...' : 'Updating...')
              : (formLanguage === 'ar' ? 'تحديث الحالة' : 'Update Status')
            }}
          </button>
        </div>
      </div>

      <!-- No Job Selected Message -->
      <div class="no-selection-message" *ngIf="!selectedJob">
        <i class="bi bi-info-circle"></i>
        <p>{{ formLanguage === 'ar' ? 'الرجاء اختيار مهمة قص للمتابعة' : 'Please select a cutting job to track' }}</p>
      </div>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- MENU BACKDROP (Click Outside to Close) -->
<!-- ============================================ -->
<div class="menu-backdrop" *ngIf="activeActionsMenu" (click)="closeActionsMenu()"></div>

<!-- ============================================ -->
<!-- VIEW DETAILS MODAL -->
<!-- ============================================ -->
<div class="modal-overlay" *ngIf="showViewModal" (click)="closeViewModal()">
  <div class="modal-container modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="bi bi-eye"></i>
        {{ formLanguage === 'ar' ? 'تفاصيل مهمة القص' : 'Cutting Job Details' }}
      </h2>
      <button class="modal-close" (click)="closeViewModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body" *ngIf="selectedJob">
      <!-- Job Information Section -->
      <div class="details-section">
        <h3 class="details-section-title">
          <i class="bi bi-info-circle"></i>
          {{ formLanguage === 'ar' ? 'معلومات المهمة' : 'Job Information' }}
        </h3>

        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'رقم المهمة:' : 'Job ID:' }}</span>
            <span class="detail-value job-id">{{ selectedJob.id }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'اسم المشروع:' : 'Project Name:' }}</span>
            <span class="detail-value">{{ selectedJob.projectName }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'اسم القطعة:' : 'Piece Name:' }}</span>
            <span class="detail-value">{{ selectedJob.pieceName || '-' }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'الكمية:' : 'Quantity:' }}</span>
            <span class="detail-value">
              <span class="quantity-badge">{{ selectedJob.quantity }}</span>
            </span>
          </div>
        </div>
      </div>

      <!-- Material Information Section -->
      <div class="details-section">
        <h3 class="details-section-title">
          <i class="bi bi-layers"></i>
          {{ formLanguage === 'ar' ? 'معلومات المادة' : 'Material Information' }}
        </h3>

        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'نوع المادة:' : 'Material Type:' }}</span>
            <span class="detail-value">
              <span class="material-badge">{{ getMaterialTypeLabel(selectedJob.materialType) }}</span>
            </span>
          </div>

          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'السماكة:' : 'Thickness:' }}</span>
            <span class="detail-value">{{ selectedJob.thickness }} {{ formLanguage === 'ar' ? 'مم' : 'mm' }}</span>
          </div>
        </div>
      </div>

      <!-- Progress Section -->
      <div class="details-section" *ngIf="selectedJob.currentlyCut !== undefined">
        <h3 class="details-section-title">
          <i class="bi bi-graph-up"></i>
          {{ formLanguage === 'ar' ? 'التقدم' : 'Progress' }}
        </h3>

        <div class="quantity-tracker">
          <div class="quantity-item quantity-total">
            <i class="bi bi-box"></i>
            <div class="quantity-info">
              <span class="quantity-label">{{ formLanguage === 'ar' ? 'العدد الكلي' : 'Total Quantity' }}</span>
              <span class="quantity-number">{{ selectedJob.quantity }}</span>
            </div>
          </div>

          <div class="quantity-item quantity-cut">
            <i class="bi bi-check2-circle"></i>
            <div class="quantity-info">
              <span class="quantity-label">{{ formLanguage === 'ar' ? 'المقصود' : 'Cut' }}</span>
              <span class="quantity-number">{{ selectedJob.currentlyCut || 0 }}</span>
            </div>
          </div>

          <div class="quantity-item quantity-remaining">
            <i class="bi bi-hourglass-split"></i>
            <div class="quantity-info">
              <span class="quantity-label">{{ formLanguage === 'ar' ? 'المتبقي' : 'Remaining' }}</span>
              <span class="quantity-number">{{ selectedJob.remaining || selectedJob.quantity }}</span>
            </div>
          </div>
        </div>

        <div class="progress-section">
          <div class="progress-header">
            <span>{{ formLanguage === 'ar' ? 'نسبة الإنجاز:' : 'Completion:' }}</span>
            <span class="progress-percentage">{{ calculateProgress(selectedJob) }}%</span>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              [style.width.%]="calculateProgress(selectedJob)"
              [style.background]="getProgressColor(calculateProgress(selectedJob))">
            </div>
          </div>
        </div>
      </div>

      <!-- Status & File Section -->
      <div class="details-section">
        <h3 class="details-section-title">
          <i class="bi bi-flag"></i>
          {{ formLanguage === 'ar' ? 'الحالة والملف' : 'Status & File' }}
        </h3>

        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'الحالة:' : 'Status:' }}</span>
            <span class="detail-value">
              <span class="status-badge" [ngClass]="getStatusColor(selectedJob.fileStatus)">
                {{ getStatusLabel(selectedJob.fileStatus) }}
              </span>
            </span>
          </div>

          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'الملف:' : 'File:' }}</span>
            <span class="detail-value">
              <button
                class="file-download-btn inline"
                *ngIf="selectedJob.fileName && selectedJob.filePath"
                (click)="downloadFile(selectedJob.id, selectedJob.fileName)">
                <i class="bi" [ngClass]="getFileIcon(selectedJob.fileName)"></i>
                <span>{{ selectedJob.fileName }}</span>
                <i class="bi bi-download"></i>
              </button>
              <span *ngIf="!selectedJob.fileName">-</span>
            </span>
          </div>
        </div>
      </div>

      <!-- Notes Section -->
      <div class="details-section" *ngIf="selectedJob.notes">
        <h3 class="details-section-title">
          <i class="bi bi-chat-text"></i>
          {{ formLanguage === 'ar' ? 'الملاحظات' : 'Notes' }}
        </h3>

        <div class="notes-box">
          <p>{{ selectedJob.notes }}</p>
        </div>
      </div>

      <!-- Additional Information Section -->
      <div class="details-section">
        <h3 class="details-section-title">
          <i class="bi bi-clock-history"></i>
          {{ formLanguage === 'ar' ? 'معلومات إضافية' : 'Additional Information' }}
        </h3>

        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'تم الرفع بواسطة:' : 'Uploaded By:' }}</span>
            <span class="detail-value">
              {{ selectedJob.uploadedByInfo ? (selectedJob.uploadedByInfo.name || selectedJob.uploadedByInfo.username) : selectedJob.uploadedBy }}
            </span>
          </div>

          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'تاريخ الإنشاء:' : 'Created At:' }}</span>
            <span class="detail-value">{{ formatDate(selectedJob.createdAt) }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">{{ formLanguage === 'ar' ? 'آخر تحديث:' : 'Last Updated:' }}</span>
            <span class="detail-value">{{ formatDate(selectedJob.updatedAt) }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeViewModal()">
        <i class="bi bi-x-circle"></i>
        {{ formLanguage === 'ar' ? 'إغلاق' : 'Close' }}
      </button>
      <button type="button" class="btn btn-primary" (click)="openEditModalFromView()">
        <i class="bi bi-pencil"></i>
        {{ formLanguage === 'ar' ? 'تعديل' : 'Edit' }}
      </button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- EDIT MODAL -->
<!-- ============================================ -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="bi bi-pencil-square"></i>
        {{ formLanguage === 'ar' ? 'تعديل مهمة القص' : 'Edit Cutting Job' }}
      </h2>
      <button class="modal-close" (click)="closeEditModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">
            {{ formLanguage === 'ar' ? 'اسم المشروع' : 'Project Name' }}
          </label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="formData.projectName"
            [class.error]="fieldErrors['projectName']"
          />
        </div>

        <div class="form-group">
          <label class="form-label">{{ formLanguage === 'ar' ? 'اسم القطعة' : 'Piece Name' }}</label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="formData.pieceName"
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">
            {{ formLanguage === 'ar' ? 'الكمية' : 'Quantity' }}
          </label>
          <input
            type="number"
            class="form-input"
            [(ngModel)]="formData.quantity"
            [class.error]="fieldErrors['quantity']"
            min="1"
          />
        </div>

        <div class="form-group">
          <label class="form-label">
            {{ formLanguage === 'ar' ? 'السماكة (مم)' : 'Thickness (mm)' }}
          </label>
          <input
            type="number"
            class="form-input"
            [(ngModel)]="formData.thickness"
            [class.error]="fieldErrors['thickness']"
            min="0"
            step="0.1"
          />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          {{ formLanguage === 'ar' ? 'نوع المادة' : 'Material Type' }}
        </label>
        <select
          class="form-select"
          [(ngModel)]="formData.materialType"
          [class.error]="fieldErrors['materialType']">
          <option value="">{{ formLanguage === 'ar' ? '-- اختر نوع المادة --' : '-- Select Material Type --' }}</option>
          <option *ngFor="let material of materialTypes" [value]="material.value">
            {{ formLanguage === 'ar' ? material.label : material.labelEn }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">{{ formLanguage === 'ar' ? 'ملاحظات' : 'Notes' }}</label>
        <textarea
          class="form-input"
          [(ngModel)]="formData.notes"
          rows="3"
        ></textarea>
      </div>

      <div class="file-upload-area">
        <input
          type="file"
          id="edit-file-input"
          class="file-input"
          (change)="onFileSelected($event)"
          accept=".dwg,.dxf,.dwt,.nc,.txt"
        />

        <label for="edit-file-input" class="file-upload-label" *ngIf="!selectedFileName">
          <i class="bi bi-cloud-upload"></i>
          <span>{{ formLanguage === 'ar' ? 'تحديث الملف (اختياري)' : 'Update File (Optional)' }}</span>
          <small>{{ formLanguage === 'ar' ? 'DWG, DXF, DWT, NC, TXT (الحد الأقصى 50 ميجابايت)' : 'DWG, DXF, DWT, NC, TXT (Max 50MB)' }}</small>
        </label>

        <div class="file-selected" *ngIf="selectedFileName">
          <div class="file-icon">
            <i class="bi" [ngClass]="getFileIcon(selectedFileName)"></i>
          </div>
          <div class="file-details">
            <p class="file-name">{{ selectedFileName }}</p>
          </div>
          <button type="button" class="btn-remove-file" (click)="removeSelectedFile()">
            <i class="bi bi-x-circle"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeEditModal()" [disabled]="updatingJob">
        {{ formLanguage === 'ar' ? 'إلغاء' : 'Cancel' }}
      </button>
      <button type="button" class="btn btn-primary" (click)="updateJob()" [disabled]="updatingJob">
        <i class="bi" [ngClass]="updatingJob ? 'bi-arrow-clockwise spin' : 'bi-check-lg'"></i>
        {{ updatingJob
          ? (formLanguage === 'ar' ? 'جاري التحديث...' : 'Updating...')
          : (formLanguage === 'ar' ? 'تحديث' : 'Update')
        }}
      </button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- DELETE CONFIRMATION MODAL -->
<!-- ============================================ -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
  <div class="modal-container modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="bi bi-exclamation-triangle text-danger"></i>
        {{ formLanguage === 'ar' ? 'تأكيد الحذف' : 'Confirm Delete' }}
      </h2>
      <button class="modal-close" (click)="closeDeleteModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body">
      <p class="delete-message">
        {{ formLanguage === 'ar'
          ? 'هل أنت متأكد من حذف مهمة القص'
          : 'Are you sure you want to delete cutting job'
        }}
        <strong>{{ selectedJob?.id }}</strong>؟
        <br>
        <span class="text-warning">
          {{ formLanguage === 'ar' ? 'لا يمكن التراجع عن هذا الإجراء!' : 'This action cannot be undone!' }}
        </span>
      </p>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()" [disabled]="deletingJob">
        {{ formLanguage === 'ar' ? 'إلغاء' : 'Cancel' }}
      </button>
      <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="deletingJob">
        <i class="bi bi-trash" *ngIf="!deletingJob"></i>
        <i class="bi bi-arrow-clockwise spin" *ngIf="deletingJob"></i>
        {{ deletingJob
          ? (formLanguage === 'ar' ? 'جاري الحذف...' : 'Deleting...')
          : (formLanguage === 'ar' ? 'حذف' : 'Delete')
        }}
      </button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- DUPLICATE CONFIRMATION MODAL -->
<!-- ============================================ -->
<div class="modal-overlay" *ngIf="showDuplicateModal" (click)="closeDuplicateModal()">
  <div class="modal-container modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="bi bi-files text-warning"></i>
        {{ formLanguage === 'ar' ? 'نسخ مهمة القص' : 'Duplicate Cutting Job' }}
      </h2>
      <button class="modal-close" (click)="closeDuplicateModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body">
      <p class="delete-message">
        {{ formLanguage === 'ar'
          ? 'هل تريد نسخ بيانات مهمة القص'
          : 'Do you want to duplicate cutting job'
        }}
        <strong>{{ jobToDuplicate?.id }}</strong>؟
        <br><br>
        <span style="color: #d97706; font-weight: 500;">
          {{ formLanguage === 'ar'
            ? 'سيتم إنشاء مهمة قص جديدة بنفس البيانات مع إمكانية التعديل.'
            : 'A new cutting job will be created with the same data that you can modify.'
          }}
        </span>
      </p>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeDuplicateModal()">
        {{ formLanguage === 'ar' ? 'إلغاء' : 'Cancel' }}
      </button>
      <button type="button" class="btn btn-primary" (click)="confirmDuplicate()">
        <i class="bi bi-files"></i>
        {{ formLanguage === 'ar' ? 'نسخ' : 'Duplicate' }}
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showUserHistoryModal" (click)="closeUserHistoryModal()">
  <div class="modal-container modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="bi bi-clock-history"></i>
        {{ formLanguage === 'ar' ? 'سجل التحديثات التفصيلي' : 'Detailed Update History' }}
      </h2>
      <button class="modal-close" (click)="closeUserHistoryModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="modal-body" *ngIf="selectedJob">
      <!-- Job Info Header -->
      <div class="history-job-header">
        <h3 class="job-title">
          <span class="job-id">{{ selectedJob.id }}</span>
          <span class="separator">-</span>
          <span class="project-name">{{ selectedJob.projectName }}</span>
        </h3>
        <p class="job-piece-name" *ngIf="selectedJob.pieceName">
          {{ selectedJob.pieceName }}
        </p>
      </div>

      <!-- Update History Timeline -->
      <div class="timeline-container">
        <div class="timeline-header">
          <i class="bi bi-journal-text"></i>
          <h3>
            {{ formLanguage === 'ar'
              ? 'سجل التحديثات الكامل'
              : 'Complete Update Log'
            }}
          </h3>
          <span class="timeline-count">
            {{ selectedJob.updateHistory?.length || 0 }}
            {{ formLanguage === 'ar' ? 'تحديث' : 'updates' }}
          </span>
        </div>

        <!-- No activities message -->
        <div class="no-activities" *ngIf="!selectedJob.updateHistory || selectedJob.updateHistory.length === 0">
          <i class="bi bi-info-circle"></i>
          <p>
            {{ formLanguage === 'ar'
              ? 'لا توجد تحديثات مسجلة'
              : 'No updates recorded'
            }}
          </p>
        </div>

        <!-- Enhanced Timeline with Detailed Information -->
        <div class="enhanced-timeline" *ngIf="selectedJob.updateHistory && selectedJob.updateHistory.length > 0">
          <div
            class="enhanced-timeline-item"
            *ngFor="let update of selectedJob.updateHistory; let i = index"
            [class.timeline-item-first]="i === 0">

            <!-- Timeline Connector Line -->
            <div class="timeline-line" *ngIf="i < selectedJob.updateHistory.length - 1"></div>

            <!-- Timeline Dot with Icon -->
            <div class="enhanced-timeline-dot" [style.background]="getActionTypeColor(update.changes.actionType)">
              <i class="bi" [ngClass]="getActionTypeIcon(update.changes.actionType)"></i>
            </div>

            <!-- Timeline Content Card -->
            <div class="enhanced-timeline-card">
              <!-- Card Header -->
              <div class="card-header">
                <div class="user-section">
                  <div class="user-avatar">
                    <i class="bi bi-person-circle"></i>
                  </div>
                  <div class="user-details">
                    <span class="user-name">
                      {{ update.updatedByInfo ? (update.updatedByInfo.name || update.updatedByInfo.username) : update.updatedBy }}
                    </span>
                    <span class="action-type-badge" [style.background]="getActionTypeColor(update.changes.actionType)">
                      {{ getActionTypeLabel(update.changes.actionType) }}
                    </span>
                  </div>
                </div>

                <div class="timestamp-section">
                  <span class="time-ago">{{ getTimeAgo(update.timestamp) }}</span>
                  <span class="exact-time">
                    <i class="bi bi-calendar3"></i>
                    {{ formatDateTime(update.timestamp) }}
                  </span>
                </div>
              </div>

              <!-- Card Body - Update Summary -->
              <div class="card-body">
                <div class="update-summary" *ngIf="hasValidSummary(update.changes.summary)">
                  <i class="bi bi-info-circle"></i>
                  <span>{{ formLanguage === 'ar' ? update.changes.summary?.ar : update.changes.summary?.en }}</span>
                </div>

                <!-- Detailed Changes List -->
                <div class="detailed-changes" *ngIf="update.changes.detailedDescriptions && update.changes.detailedDescriptions.length > 0">
                  <div class="changes-header">
                    <i class="bi bi-list-ul"></i>
                    <span>{{ formLanguage === 'ar' ? 'التغييرات التفصيلية:' : 'Detailed Changes:' }}</span>
                  </div>

                  <div class="changes-list">
                    <div class="change-loop" *ngFor="let change of update.changes.detailedDescriptions">
                      <div
                        class="change-item"
                        *ngIf="shouldShowChange(change)"
                        [class.change-progress]="change.field === 'currentlyCut'"
                        [class.change-status]="change.field === 'fileStatus'"
                        [class.change-with-notes]="change.notes">



                      <!-- Change Icon -->
                      <div class="change-icon">
                        <i class="bi" [ngClass]="getChangeFieldIcon(change.field)"></i>
                      </div>

                      <!-- Change Details -->
                      <div class="change-details">
                        <div class="change-description">
                          {{ formLanguage === 'ar' ? change.descriptionAr : change.description }}
                        </div>

                        <!-- Progress-specific visualization -->
                        <div class="progress-visualization" *ngIf="change.field === 'currentlyCut' && change.progressPercentage !== undefined">
                          <div class="progress-info-row">
                            <div class="mini-progress-bar">
                              <div class="mini-progress-fill"
                                   [style.width.%]="change.progressPercentage"
                                   [style.background]="getProgressColor(change.progressPercentage)">
                              </div>
                            </div>
                            <span class="progress-text">
                              {{ change.progress }}
                              <span class="difference-badge"
                                    *ngIf="change.difference !== undefined"
                                    [class.positive]="change.difference > 0"
                                    [class.negative]="change.difference < 0">
                                {{ change.difference > 0 ? '+' : '' }}{{ change.difference }}
                              </span>
                            </span>
                          </div>
                        </div>

                        <!-- Status change visualization -->
                        <div class="status-change-visualization" *ngIf="change.field === 'fileStatus'">
                          <div class="status-flow">
                            <span class="status-badge old-status" [ngClass]="getStatusColor(change.oldValue)">
                              {{ getStatusLabel(change.oldValue) }}
                            </span>
                            <i class="bi bi-arrow-right"></i>
                            <span class="status-badge new-status" [ngClass]="getStatusColor(change.newValue)">
                              {{ getStatusLabel(change.newValue) }}
                            </span>
                          </div>
                          <span class="reason-text" *ngIf="change.reason">
                            <i class="bi bi-info-circle"></i>
                            {{ change.reason }}
                          </span>
                        </div>

                        <!-- Generic value change -->
                        <div class="value-change" *ngIf="change.field !== 'currentlyCut' && change.field !== 'fileStatus'">
                          <span class="old-value">{{ change.oldValue || '-' }}</span>
                          <i class="bi bi-arrow-right"></i>
                          <span class="new-value">{{ change.newValue }}</span>
                        </div>

                        <!-- ✅ SHOW NOTES ASSOCIATED WITH THIS SPECIFIC CHANGE -->
                        <div class="change-notes" *ngIf="change.notes">
                          <div class="notes-icon">
                            <i class="bi bi-sticky"></i>
                          </div>
                          <div class="notes-box">
                            <span class="notes-label-small">{{ formLanguage === 'ar' ? 'ملاحظة:' : 'Note:' }}</span>
                            <p class="notes-text-small">{{ change.notes }}</p>
                          </div>
                        </div>
                      </div>
                  </div>
                </div>

                <!-- Creation Details (for initial job creation) -->
                <div class="creation-details" *ngIf="update.changes.actionType === 'job_created' && update.changes.details">
                  <div class="details-grid-compact">
                    <div class="detail-compact">
                      <i class="bi bi-folder"></i>
                      <span>{{ update.changes.details.projectName }}</span>
                    </div>
                    <div class="detail-compact" *ngIf="update.changes.details.pieceName">
                      <i class="bi bi-puzzle"></i>
                      <span>{{ update.changes.details.pieceName }}</span>
                    </div>
                    <div class="detail-compact">
                      <i class="bi bi-hash"></i>
                      <span>{{ formLanguage === 'ar' ? 'الكمية:' : 'Qty:' }} {{ update.changes.details.quantity }}</span>
                    </div>
                    <div class="detail-compact">
                      <i class="bi bi-layers"></i>
                      <span>{{ getMaterialTypeLabel(update.changes.details.materialType) }}</span>
                    </div>
                    <div class="detail-compact">
                      <i class="bi bi-rulers"></i>
                      <span>{{ update.changes.details.thickness }}mm</span>
                    </div>
                    <div class="detail-compact" *ngIf="update.changes.details.fileName">
                      <i class="bi bi-file-earmark"></i>
                      <span>{{ update.changes.details.fileName }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Summary Statistics -->
      <div class="history-summary-stats">
        <div class="summary-stats-header">
          <i class="bi bi-graph-up"></i>
          <h4>{{ formLanguage === 'ar' ? 'إحصائيات التحديثات' : 'Update Statistics' }}</h4>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <i class="bi bi-journal-text"></i>
            <div class="stat-content">
              <span class="stat-label">{{ formLanguage === 'ar' ? 'إجمالي التحديثات' : 'Total Updates' }}</span>
              <span class="stat-value">{{ selectedJob.updateHistory ? selectedJob.updateHistory.length : 0 }}</span>
            </div>
          </div>

          <div class="stat-card">
            <i class="bi bi-people"></i>
            <div class="stat-content">
              <span class="stat-label">{{ formLanguage === 'ar' ? 'المستخدمون' : 'Users' }}</span>
              <span class="stat-value">{{ getUniqueUsersCount() }}</span>
            </div>
          </div>

          <div class="stat-card">
            <i class="bi bi-clipboard-check"></i>
            <div class="stat-content">
              <span class="stat-label">{{ formLanguage === 'ar' ? 'تحديثات التقدم' : 'Progress Updates' }}</span>
              <span class="stat-value">{{ getProgressUpdatesCount() }}</span>
            </div>
          </div>

          <div class="stat-card">
            <i class="bi bi-flag"></i>
            <div class="stat-content">
              <span class="stat-label">{{ formLanguage === 'ar' ? 'تغييرات الحالة' : 'Status Changes' }}</span>
              <span class="stat-value">{{ getStatusChangesCount() }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeUserHistoryModal()">
        <i class="bi bi-x-circle"></i>
        {{ formLanguage === 'ar' ? 'إغلاق' : 'Close' }}
      </button>

    </div>
  </div>
</div>
