<!-- purchases.component.html - CORRECTED: Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ instead of Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ -->

<div class="purchases-container">

  <!-- TOAST NOTIFICATIONS CONTAINER -->
  <div class="toast-container" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'">
    <div
      *ngFor="let toast of toasts"
      class="toast"
      [class.toast-success]="toast.type === 'success'"
      [class.toast-error]="toast.type === 'error'"
      [class.toast-info]="toast.type === 'info'"
      [class.toast-warning]="toast.type === 'warning'">

      <div class="toast-icon">
        <i class="bi"
           [ngClass]="{
             'bi-check-circle-fill': toast.type === 'success',
             'bi-x-circle-fill': toast.type === 'error',
             'bi-info-circle-fill': toast.type === 'info',
             'bi-exclamation-triangle-fill': toast.type === 'warning'
           }"></i>
      </div>

      <div class="toast-content">
        <p class="toast-message">{{ toast.message }}</p>
      </div>

      <button class="toast-close" (click)="removeToast(toast.id)">
        <i class="bi bi-x"></i>
      </button>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div *ngIf="showSuccessModal" class="success-modal-overlay" (click)="closeSuccessModal()">
    <div class="success-modal" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'" (click)="$event.stopPropagation()">

      <!-- Header -->
      <div class="success-header">
        <button class="close-btn" (click)="closeSuccessModal()">
          <i class="bi bi-x-lg"></i>
        </button>

        <div class="success-icon-wrapper">
          <i class="bi bi-check-circle-fill"></i>
        </div>

        <h2>{{ formLanguage === 'ar' ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­' : 'Purchase Order Created Successfully' }}</h2>
      </div>

      <!-- Body -->
      <div class="success-body">

        <!-- PDF Info Box -->
        <div class="pdf-info-box">
          <i class="bi bi-file-earmark-pdf-fill"></i>
          <div class="pdf-details">
            <p class="pdf-filename">{{ successPONumber }}.pdf</p>
            <p class="pdf-status">
              {{ formLanguage === 'ar' ? 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„' : 'Ready to view and download' }}
            </p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <!-- View PDF -->
          <button class="action-btn btn-view" (click)="viewPDFFromSuccess()">
            <div class="btn-icon">
              <i class="bi bi-eye-fill"></i>
            </div>
            <span class="btn-label">
              {{ formLanguage === 'ar' ? 'Ø¹Ø±Ø¶ PDF' : 'View PDF' }}
            </span>
          </button>

          <!-- Print PDF -->
          <button class="action-btn btn-print" (click)="printPDFFromSuccess()">
            <div class="btn-icon">
              <i class="bi bi-printer-fill"></i>
            </div>
            <span class="btn-label">
              {{ formLanguage === 'ar' ? 'Ø·Ø¨Ø§Ø¹Ø©' : 'Print' }}
            </span>
          </button>

          <!-- Download PDF -->
          <button class="action-btn btn-download" (click)="downloadPDFFromSuccess()">
            <div class="btn-icon">
              <i class="bi bi-download"></i>
            </div>
            <span class="btn-label">
              {{ formLanguage === 'ar' ? 'ØªØ­Ù…ÙŠÙ„' : 'Download' }}
            </span>
          </button>
          <!-- Share Button -->
          <button class="action-btn btn-share" (click)="shareFromSuccessModal()">
            <div class="btn-icon">
              <i class="bi bi-envelope-fill"></i>
            </div>
            <span class="btn-label">
              {{ formLanguage === 'ar' ? 'Ù…Ø´Ø§Ø±ÙƒØ©' : 'Share' }}
            </span>
          </button>
        </div>

        <!-- Done Button -->
        <button class="done-button" (click)="doneSuccess()">
          <i class="bi bi-check-circle"></i>
          {{ formLanguage === 'ar' ? 'ØªÙ…' : 'Done' }}
        </button>
      </div>

    </div>
  </div>

  <!-- LIST VIEW -->
  <div *ngIf="currentView === 'list'" class="list-view">
    <!-- Header -->
    <div class="page-header">
      <h1 class="page-title">{{ formLanguage === 'ar' ? 'Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡' : 'Purchase Orders' }}</h1>
      <div class="header-actions">
        <!-- Language Toggle -->
        <div class="language-toggle">
          <button
            type="button"
            class="lang-btn"
            [class.active]="formLanguage === 'ar'"
            (click)="toggleFormLanguage('ar')">
            <i class="bi bi-translate"></i>
            Ø¹Ø±Ø¨ÙŠ
          </button>
          <button
            type="button"
            class="lang-btn"
            [class.active]="formLanguage === 'en'"
            (click)="toggleFormLanguage('en')">
            <i class="bi bi-translate"></i>
            English
          </button>

        </div>
                        <!-- Supplier Management Button -->
      <button class="btn-secondary btn-suppliers" (click)="navigateToSuppliers()">
        <i class="bi bi-truck"></i>
        {{ formLanguage === 'ar' ? 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†' : 'Supplier Management' }}
      </button>
        <button class="btn-primary" (click)="createPO()">
          <i class="bi bi-plus-lg"></i>
          {{ formLanguage === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡' : 'Create Purchase Order' }}
        </button>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter-section" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'">
      <div class="search-box main-search">
        <i class="bi bi-search"></i>
        <input
          type="text"
          [placeholder]="formLanguage === 'ar' ? 'Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ØŒ Ø§Ù„Ù…ÙˆØ±Ø¯ ...' : 'Search by PO number, supplier ...'"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchChange()"
          (keyup.enter)="onSearch()"
        />
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table class="pos-table">
        <thead>
          <tr>
            <th class="text-center">{{ formLanguage === 'ar' ? 'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨' : 'PO #' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'Ø§Ù„Ù…ÙˆØ±Ø¯' : 'Supplier' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'Ø§Ù„Ù…Ø³ØªÙ„Ù…' : 'Receiver' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'Ø§Ù„ØªØ§Ø±ÙŠØ®' : 'Date' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'Ù…Ù†Ø´Ø¦' : 'Created By' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'Ø§Ù„Ø¯ÙˆØ±' : 'Role' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª' : 'Actions' }}</th>
          </tr>
        </thead>
        <tbody *ngIf="!loading && pos.length > 0">
          <tr *ngFor="let po of pos">
            <td class="po-number text-center">{{ po.poNumber }}</td>
            <td class="po-supplier text-center">{{ po.supplier }}</td>
            <td class="po-receiver text-center">{{ po.receiver }}</td>
            <td class="text-center">{{ po.date }}</td>
            <td class="text-center">{{ getCreatorName(po) }}</td>
            <td class="text-center">
              <span class="role-badge" [ngClass]="getRoleClass(po.createdByRole)">
                {{ getRoleText(po.createdByRole) }}
              </span>
            </td>

<td class="actions-cell text-center">
  <button
    class="btn-icon btn-view"
    (click)="viewPDF(po)"
    [title]="formLanguage === 'ar' ? 'Ø¹Ø±Ø¶ PDF' : 'View PDF'">
    <i class="bi bi-eye"></i>
  </button>
  <button
    class="btn-icon btn-print"
    (click)="printPOPDF(po)"
    [title]="formLanguage === 'ar' ? 'Ø·Ø¨Ø§Ø¹Ø©' : 'Print'">
    <i class="bi bi-printer"></i>
  </button>
  <button
    class="btn-icon btn-download"
    (click)="downloadPDF(po)"
    [title]="formLanguage === 'ar' ? 'ØªØ­Ù…ÙŠÙ„ PDF' : 'Download PDF'">
    <i class="bi bi-download"></i>
  </button>
  <button 
    class="btn-icon btn-share" 
    (click)="openShareModal(po)" 
    [title]="formLanguage === 'ar' ? 'Ù…Ø´Ø§Ø±ÙƒØ©' : 'Share'">
    <i class="bi bi-envelope"></i>
  </button>

  <!-- âœ… NEW: DUPLICATE BUTTON -->
  <button
    class="btn-icon btn-duplicate"
    (click)="openDuplicateModal(po)"
    [title]="formLanguage === 'ar' ? 'Ù†Ø³Ø® ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù…' : 'Duplicate & Reuse'">
    <i class="bi bi-files"></i>
  </button>

  <button
    class="btn-icon btn-edit"
    (click)="editPO(po)"
    [title]="formLanguage === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Edit'">
    <i class="bi bi-pencil"></i>
  </button>
  <button
    class="btn-icon btn-delete"
    (click)="showDeleteConfirmation(po)"
    [title]="formLanguage === 'ar' ? 'Ø­Ø°Ù' : 'Delete'">
    <i class="bi bi-trash"></i>
  </button>
</td>
          </tr>
        </tbody>
        <tbody *ngIf="loading">
          <tr>
            <td colspan="7" class="text-center loading-cell">
              <i class="bi bi-arrow-clockwise spin"></i> {{ formLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'Loading...' }}
            </td>
          </tr>
        </tbody>
        <tbody *ngIf="!loading && pos.length === 0">
          <tr>
            <td colspan="7" class="text-center empty-cell">
              {{ formLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø´Ø±Ø§Ø¡' : 'No purchase orders found' }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button
        class="btn-page"
        [disabled]="currentPage === 1"
        (click)="goToPage(currentPage - 1)">
        <i class="bi bi-chevron-left"></i>
      </button>

      <span class="page-info">
        {{ formLanguage === 'ar' ? 'ØµÙØ­Ø©' : 'Page' }} {{ currentPage }} {{ formLanguage === 'ar' ? 'Ù…Ù†' : 'of' }} {{ totalPages }}
      </span>

      <button
        class="btn-page"
        [disabled]="currentPage === totalPages"
        (click)="goToPage(currentPage + 1)">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- CREATE/EDIT VIEW -->
  <div
    *ngIf="currentView === 'create' || currentView === 'edit'"
    class="form-view"
    [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'">
    <!-- Header -->
    <div class="form-header">
      <h1 class="form-title">
        {{ currentView === 'create'
          ? (formLanguage === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡' : 'Create Purchase Order')
          : (formLanguage === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡' : 'Edit Purchase Order')
        }}
      </h1>
      <div class="form-header-actions">
        <div class="form-actions">
          <button class="btn-secondary" (click)="backToList()">
            {{ formLanguage === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
          </button>
          <button
            class="btn-primary"
            (click)="savePO()"
            [disabled]="savingPO">
            <i class="bi bi-save"></i>
            {{ savingPO
              ? (formLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'Saving...')
              : (formLanguage === 'ar' ? 'Ø­ÙØ¸' : 'Save')
            }}
          </button>
        </div>
      </div>
    </div>

    <!-- Error Alert -->
    <div class="error-alert" *ngIf="formError">
      <i class="bi bi-exclamation-circle"></i>
      <span>{{ formError }}</span>
    </div>

    <!-- Form Content -->
    <div class="form-content">
      <!-- Sidebar Navigation -->
      <div class="form-sidebar">
        <button
          class="sidebar-step"
          [class.active]="currentStep === 'basic'"
          (click)="currentStep = 'basic'">
          {{ formLanguage === 'ar' ? 'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©' : 'Basic Info' }}
        </button>
        <button
          class="sidebar-step"
          [class.active]="currentStep === 'items'"
          [class.has-error]="fieldErrors['items']"
          (click)="currentStep = 'items'">
            {{ formLanguage === 'ar' ? 'Ø§Ù„Ø¹Ù†Ø§ØµØ±  (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : ' Items (Optional)' }}
          <span class="item-count" [class.error-count]="fieldErrors['items']">{{ getItemsCount() }}</span>
        </button>
        <button
          class="sidebar-step"
          [class.active]="currentStep === 'options'"
          (click)="currentStep = 'options'">
          {{ formLanguage === 'ar' ? 'Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…' : 'Terms & Conditions' }}
        </button>
      </div>

      <!-- Form Fields -->
      <div class="form-fields">

        <!-- STEP 1: Basic Info -->
        <div *ngIf="currentStep === 'basic'" class="step-content">
          <h2 class="step-title">
            {{ formLanguage === 'ar' ? 'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)' : 'Basic Info (Optional)' }}
          </h2>

          <!-- âœ… Info Alert -->
          <div class="info-alert">
            <i class="bi bi-info-circle"></i>
            <div style="flex: 1;">
              <p>
                {{ formLanguage === 'ar'
                  ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©. ÙÙ‚Ø· Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù…Ù„ÙˆØ¡Ø© Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ù…Ù„Ù PDF.'
                  : 'All fields are optional. Only filled fields will appear in the PDF.'
                }}
              </p>
            </div>
          </div>
          <!-- Date Field -->
          <div class="form-group">
            <label>
              <i class="bi bi-calendar"></i>
              {{ formLanguage === 'ar' ? 'Ø§Ù„ØªØ§Ø±ÙŠØ®' : 'Date' }}
            </label>
            <input
              type="date"
              [(ngModel)]="poForm.date"
              class="form-control"
              [class.error]="fieldErrors['date']"
              required
            />
            <small class="error-message" *ngIf="fieldErrors['date']">
              <i class="bi bi-exclamation-circle"></i>
              {{ fieldErrors['date'] }}
            </small>
          </div>

          <!-- Supplier Section -->
          <div class="section-divider">
            <span class="section-title">{{ formLanguage === 'ar' ? 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯' : 'Supplier Information' }}</span>
          </div>

          <div class="form-group">
            <label>
              <i class="bi bi-truck"></i>
              {{ formLanguage === 'ar' ? 'Ø§Ù„Ù…ÙˆØ±Ø¯' : 'Supplier' }}
            </label>
            <select
              [(ngModel)]="poForm.supplier"
              (ngModelChange)="onSupplierChange()"
              class="form-control"
              [class.error]="fieldErrors['supplier']"
              [disabled]="loadingSuppliers"
              required
            >
              <option value="" disabled selected>
                {{ loadingSuppliers
                  ? (formLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'Loading...')
                  : (formLanguage === 'ar' ? 'Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯' : 'Select Supplier')
                }}
              </option>
              <option *ngFor="let supplier of suppliers" [value]="supplier.name">
                {{ supplier.name }}
              </option>
            </select>
            <small class="error-message" *ngIf="fieldErrors['supplier']">
              <i class="bi bi-exclamation-circle"></i>
              {{ fieldErrors['supplier'] }}
            </small>
          </div>

          <!-- Supplier Address and Phone Row -->
          <div class="form-row">
            <div class="form-group">
              <label>
                <i class="bi bi-geo-alt"></i>
                {{ formLanguage === 'ar' ? 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ±Ø¯' : 'Supplier Address' }}
              </label>
              <input
                type="text"
                [(ngModel)]="poForm.supplierAddress"
                [placeholder]="formLanguage === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' : 'Address'"
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label>
                <i class="bi bi-telephone"></i>
                {{ formLanguage === 'ar' ? 'Ù‡Ø§ØªÙ Ø§Ù„Ù…ÙˆØ±Ø¯' : 'Supplier Phone' }}
              </label>
              <input
                type="text"
                [(ngModel)]="poForm.supplierPhone"
                [placeholder]="formLanguage === 'ar' ? 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ' : 'Phone Number'"
                class="form-control"
              />
            </div>
          </div>

          <!-- Receiver Section -->
          <div class="section-divider">
            <span class="section-title">{{ formLanguage === 'ar' ? 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…' : 'Receiver Information' }}</span>
          </div>

          <!-- Receiver Name -->
          <div class="form-group">
            <label>
              <i class="bi bi-person"></i>
              {{ formLanguage === 'ar' ? 'Ø§Ù„Ù…Ø³ØªÙ„Ù…' : 'Receiver' }}
            </label>
            <input
              type="text"
              [(ngModel)]="poForm.receiver"
              [placeholder]="formLanguage === 'ar' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…' : 'Receiver Name'"
              class="form-control"
              [class.error]="fieldErrors['receiver']"
              required
            />
            <small class="error-message" *ngIf="fieldErrors['receiver']">
              <i class="bi bi-exclamation-circle"></i>
              {{ fieldErrors['receiver'] }}
            </small>
          </div>

          <!-- Receiver City and Address Row -->
          <div class="form-row">
            <div class="form-group">
              <label>
                <i class="bi bi-pin-map"></i>
                {{ formLanguage === 'ar' ? 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©' : 'City' }}
              </label>
              <input
                type="text"
                [(ngModel)]="poForm.receiverCity"
                [placeholder]="formLanguage === 'ar' ? 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©' : 'City'"
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label>
                <i class="bi bi-geo-alt"></i>
                {{ formLanguage === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' : 'Address' }}
              </label>
              <input
                type="text"
                [(ngModel)]="poForm.receiverAddress"
                [placeholder]="formLanguage === 'ar' ? 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ„Ù…' : 'Receiver Address'"
                class="form-control"
              />
            </div>
          </div>

          <!-- Receiver Phone -->
          <div class="form-group">
            <label>
              <i class="bi bi-telephone"></i>
              {{ formLanguage === 'ar' ? 'Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªÙ„Ù…' : 'Receiver Phone' }}
            </label>
            <input
              type="text"
              [(ngModel)]="poForm.receiverPhone"
              [placeholder]="formLanguage === 'ar' ? 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ' : 'Phone Number'"
              class="form-control"
            />
          </div>

          <!-- Additional Info Section -->
          <div class="section-divider">
            <span class="section-title">{{ formLanguage === 'ar' ? 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©' : 'Additional Information' }}</span>
          </div>

          <!-- Table Header Text -->
          <div class="form-group">
            <label>
              <i class="bi bi-text-paragraph"></i>
              {{ formLanguage === 'ar' ? 'Ù†Øµ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„' : 'Table Header Text' }}
            </label>
            <input
              type="text"
              [(ngModel)]="poForm.tableHeaderText"
              [placeholder]="formLanguage === 'ar' ? 'Ù†Øµ Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„' : 'Optional table header text'"
              class="form-control"
            />
          </div>

          <!-- Tax Rate -->
          <div class="form-group">
            <label>
              <i class="bi bi-percent"></i>
              {{ formLanguage === 'ar' ? 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©' : 'Tax Rate (%)' }}
            </label>
            <input
              type="number"
              [(ngModel)]="poForm.taxRate"
              [placeholder]="formLanguage === 'ar' ? 'Ù…Ø«Ø§Ù„: 16' : 'e.g. 16'"
              class="form-control"
              min="0"
              max="100"
              step="0.01"
            />
          </div>

          <!-- Notes Field -->
          <div class="form-group">
            <label>
              <i class="bi bi-chat-left-text"></i>
              {{ formLanguage === 'ar' ? 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª' : 'Notes' }}
            </label>
            <textarea
              [(ngModel)]="poForm.notes"
              [placeholder]="formLanguage === 'ar' ? 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©' : 'Additional notes'"
              class="form-control"
              rows="3"
            ></textarea>
          </div>

          <!-- PDF Attachment Upload -->
          <div class="form-group">
            <label>
              <i class="bi bi-paperclip"></i>
              {{ formLanguage === 'ar' ? 'Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù PDF (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'Attach PDF File (Optional)' }}
            </label>

            <div class="file-upload-wrapper">
              <input
                type="file"
                id="form-pdf-attachment"
                accept=".pdf"
                (change)="onFormPdfAttachmentSelected($event)"
                class="file-input"
              />
              <label for="form-pdf-attachment" class="file-upload-label">
                <i class="bi bi-cloud-upload"></i>
                <span>{{ formLanguage === 'ar' ? 'Ø§Ø®ØªØ± Ù…Ù„Ù PDF' : 'Choose PDF File' }}</span>
              </label>
            </div>

            <div *ngIf="formPdfAttachment" class="file-selected">
              <i class="bi bi-check-circle-fill"></i>
              <span class="file-name">{{ formPdfAttachment.name }}</span>
              <button class="btn-remove-file" (click)="removeFormPdfAttachment()" type="button">
                <i class="bi bi-x"></i>
              </button>
            </div>

            <small class="help-text">
              {{ formLanguage === 'ar'
                ? 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª. Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ù…Ø¹ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡.'
                : 'Maximum file size: 10MB. The attached file will be merged with the purchase order.'
              }}
            </small>
          </div>

          <div class="form-navigation">
              <!-- âœ… UPDATED: Next button now goes to 'options' -->
            <button class="btn-primary btn-next" (click)="nextStep()" type="button">
              {{ formLanguage === 'ar' ? 'Ø§Ù„ØªØ§Ù„ÙŠ' : 'Next' }}
              <i class="bi" [ngClass]="formLanguage === 'ar' ? 'bi-arrow-left' : 'bi-arrow-right'"></i>
            </button>
          </div>
        </div>

        <div *ngIf="currentStep === 'items'" class="step-content">
          <h2 class="step-title">
            {{ formLanguage === 'ar' ? 'Ø§Ù„Ø¹Ù†Ø§ØµØ±  (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'Items (Optional)' }}
            <span class="optional-badge">{{ formLanguage === 'ar' ? 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ' : 'Optional' }}</span>
          </h2>

          <!-- âœ… Info Alert -->
          <div class="info-alert">
            <i class="bi bi-info-circle"></i>
            <div style="flex: 1;">
              <p>
                {{ formLanguage === 'ar'
                  ? 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© . Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„ÙˆØ­Ø¯Ø© Ù…ØªÙˆÙØ±Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹.'
                  : 'You can select an item from the list or enter a custom item. If the unit is not available, you can enter it manually.'
                }}
              </p>
            </div>
          </div>

          <div class="error-alert" *ngIf="fieldErrors['items']" style="margin-bottom: 1.5rem;">
            <i class="bi bi-exclamation-circle"></i>
            <span>{{ fieldErrors['items'] }}</span>
          </div>

          <div class="items-section">
            <!-- Items List - CARD DESIGN -->
            <div class="items-body" *ngIf="poForm.items.length > 0">
              <ng-container *ngFor="let item of poForm.items; let i = index">
                <div class="item-card">
                  <!-- Card Header -->
                  <div class="item-card-header">
                    <span class="item-number">{{ formLanguage === 'ar' ? 'Ø¹Ù†ØµØ±' : 'Item' }} #{{ i + 1 }}</span>
                    <button class="btn-remove" (click)="removeItem(i)" type="button">
                      <i class="bi bi-trash"></i>
                      {{ formLanguage === 'ar' ? 'Ø­Ø°Ù' : 'Delete' }}
                    </button>
                  </div>

                  <!-- âœ… Card Body WITH ITEM SELECTION -->
                  <div class="item-card-body">

                    <!-- Row 1: Item Selection Dropdown -->
                    <div class="item-field">
                      <label class="field-label">
                        <i class="bi bi-box-seam"></i>
                        {{ formLanguage === 'ar' ? 'Ø§Ù„ØµÙ†Ù' : 'Item' }}
                      </label>

                      <!-- âœ… Dropdown to select from Items API -->
                      <select
                        [value]="getSelectedItemId(i)"
                        (change)="onItemSelected(i, $any($event.target).value)"
                        class="item-input item-select"
                        [class.error]="fieldErrors['item_' + i + '_description']">
                        <option value="">
                          {{ formLanguage === 'ar' ? 'Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø£Ø¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹' : 'Select from list or enter manually' }}
                        </option>
                        <optgroup [label]="formLanguage === 'ar' ? 'ğŸ“¦ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…ØªØ§Ø­Ø©' : 'ğŸ“¦ Available Items'">
                          <option *ngFor="let availableItem of availableItems" [value]="availableItem.id">
                            {{ availableItem.name }}
                            <span *ngIf="availableItem.unit"> ({{ availableItem.unit }})</span>
                          </option>
                        </optgroup>
                      </select>

                      <!-- âœ… Loading indicator -->
                      <div *ngIf="loadingItems" class="loading-items">
                        <i class="bi bi-arrow-clockwise spin"></i>
                        {{ formLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù...' : 'Loading items...' }}
                      </div>

                      <small class="error-message" *ngIf="fieldErrors['item_' + i + '_description']">
                        <i class="bi bi-exclamation-circle"></i>
                        {{ fieldErrors['item_' + i + '_description'] }}
                      </small>
                    </div>

                    <!-- âœ… Custom Description Input (shows when no item is selected or custom item) -->
                    <div class="item-field" *ngIf="!getSelectedItemId(i) || isCustomItem(i)">
                      <label class="field-label">
                        <i class="bi bi-pencil"></i>
                        {{ formLanguage === 'ar' ? 'Ø§Ù„ÙˆØµÙ (Ù…Ø®ØµØµ)' : 'Description (Custom)' }}
                      </label>
                      <input
                        type="text"
                        [(ngModel)]="item.description"
                        class="item-input"
                        [class.error]="fieldErrors['item_' + i + '_description']"
                        [placeholder]="formLanguage === 'ar' ? 'Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„ØµÙ†Ù' : 'Enter item description'"
                      />
                    </div>

                    <!-- Row 2: Unit and Quantity (2 Columns) -->
                    <div class="item-row-fields">
                      <!-- âœ… Unit (Auto-filled or manual) -->
                      <div class="item-field">
                        <label class="field-label">
                          <i class="bi bi-rulers"></i>
                          {{ formLanguage === 'ar' ? 'Ø§Ù„ÙˆØ­Ø¯Ø©' : 'Unit' }}
                          <!-- âœ… Show "ØªÙ„Ù‚Ø§Ø¦ÙŠ" badge ONLY if unit is auto-filled AND has value -->
                          <span *ngIf="hasAutoFilledUnit(i)" class="auto-filled-badge">
                            {{ formLanguage === 'ar' ? 'ØªÙ„Ù‚Ø§Ø¦ÙŠ' : 'Auto' }}
                          </span>
                        </label>
                        <input
                          type="text"
                          [(ngModel)]="item.unit"
                          class="item-input"
                          [class.error]="fieldErrors['item_' + i + '_unit']"
                          [class.auto-filled-input]="hasAutoFilledUnit(i)"
                          [placeholder]="formLanguage === 'ar' ? 'Ù…Ø«Ø§Ù„: ÙƒØ¬Ù…ØŒ Ù…ØªØ±' : 'e.g. kg, meter'"
                        />
                        <small class="help-text" *ngIf="getSelectedItemId(i) && !hasAutoFilledUnit(i)">
                          <i class="bi bi-info-circle"></i>
                          {{ formLanguage === 'ar'
                            ? 'Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹.'
                            : 'Unit not available. You can enter it manually.'
                          }}
                        </small>
                        <small class="error-message" *ngIf="fieldErrors['item_' + i + '_unit']">
                          <i class="bi bi-exclamation-circle"></i>
                          {{ fieldErrors['item_' + i + '_unit'] }}
                        </small>
                      </div>

                      <!-- Quantity -->
                      <div class="item-field">
                        <label class="field-label">
                          <i class="bi bi-123"></i>
                          {{ formLanguage === 'ar' ? 'Ø§Ù„ÙƒÙ…ÙŠØ©' : 'Quantity' }}
                        </label>
                        <input
                          type="number"
                          [(ngModel)]="item.quantity"
                          class="item-input"
                          [class.error]="fieldErrors['item_' + i + '_quantity']"
                          [placeholder]="formLanguage === 'ar' ? 'Ø§Ù„ÙƒÙ…ÙŠØ©' : 'Qty'"
                          min="0"
                          step="1"
                        />
                        <small class="error-message" *ngIf="fieldErrors['item_' + i + '_quantity']">
                          <i class="bi bi-exclamation-circle"></i>
                          {{ fieldErrors['item_' + i + '_quantity'] }}
                        </small>
                      </div>
                    </div>

                    <!-- Row 3: Unit Price and Total (2 Columns) -->
                    <div class="item-row-fields">
                      <!-- Unit Price -->
                      <div class="item-field">
                        <label class="field-label">
                          <i class="bi bi-currency-dollar"></i>
                          {{ formLanguage === 'ar' ? 'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©' : 'Unit Price' }}
                        </label>
                        <input
                          type="number"
                          [(ngModel)]="item.unitPrice"
                          class="item-input"
                          [class.error]="fieldErrors['item_' + i + '_unitPrice']"
                          [placeholder]="formLanguage === 'ar' ? 'Ø§Ù„Ø³Ø¹Ø±' : 'Price'"
                          min="0"
                          step="0.01"
                        />
                        <small class="error-message" *ngIf="fieldErrors['item_' + i + '_unitPrice']">
                          <i class="bi bi-exclamation-circle"></i>
                          {{ fieldErrors['item_' + i + '_unitPrice'] }}
                        </small>
                      </div>

                      <!-- Total (Auto-calculated, Read-only) -->
                      <div class="item-field">
                        <label class="field-label">
                          <i class="bi bi-calculator"></i>
                          {{ formLanguage === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ' : 'Total' }}
                        </label>
                        <input
                          type="text"
                          [value]="calculateItemTotal(item) | number:'1.2-2'"
                          class="item-input total-field"
                          readonly
                          disabled
                        />
                      </div>
                    </div>

                  </div>
                </div>
              </ng-container>
            </div>

            <!-- Empty State -->
            <div class="items-empty" *ngIf="poForm.items.length === 0">
              <i class="bi bi-inbox" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
              <p style="margin: 0; color: #64748b;">
                {{ formLanguage === 'ar' ? 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯' : 'No items added yet' }}
              </p>
            </div>

            <!-- Add Item Button -->
            <button class="btn-add-item" (click)="addItem()" type="button">
              <i class="bi bi-plus-lg"></i>
              {{ formLanguage === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±' : 'Add Item' }}
            </button>
          </div>

          <!-- Totals Summary -->
          <div class="totals-summary" *ngIf="poForm.items.length > 0">
            <div class="totals-box">
              <div class="total-row">
                <span class="total-label">{{ formLanguage === 'ar' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:' : 'Subtotal:' }}</span>
                <span class="total-value">{{ calculateSubtotal() | number:'1.2-2' }}</span>
              </div>
              <div class="total-row" *ngIf="poForm.taxRate > 0">
                <span class="total-label">
                  {{ formLanguage === 'ar' ? 'Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©' : 'Tax' }} ({{ poForm.taxRate }}%):
                </span>
                <span class="total-value">{{ calculateTax() | number:'1.2-2' }}</span>
              </div>
              <div class="total-row total-final">
                <span class="total-label">{{ formLanguage === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:' : 'Grand Total:' }}</span>
                <span class="total-value">{{ calculateTotal() | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>

          <!-- Navigation Buttons -->
          <div class="form-navigation">
            <button class="btn-secondary btn-back" (click)="previousStep()" type="button">
              <i class="bi" [ngClass]="formLanguage === 'ar' ? 'bi-arrow-right' : 'bi-arrow-left'"></i>
              {{ formLanguage === 'ar' ? 'Ø§Ù„Ø³Ø§Ø¨Ù‚' : 'Back' }}
            </button>
            <button class="btn-primary btn-next" (click)="nextStep()">
              {{ formLanguage === 'ar' ? 'Ø§Ù„ØªØ§Ù„ÙŠ' : 'Next' }}
              <i class="bi" [ngClass]="formLanguage === 'ar' ? 'bi-arrow-left' : 'bi-arrow-right'"></i>
            </button>
          </div>
        </div>




        <!-- STEP 3: PDF Options -->
<!-- STEP 3: Terms & Conditions -->
<div *ngIf="currentStep === 'options'" class="step-content">
  <h2 class="step-title">
    {{ formLanguage === 'ar' ? 'Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…' : 'Terms & Conditions' }}
  </h2>

  <!-- Info Alert -->
  <div class="info-alert">
    <i class="bi bi-info-circle"></i>
    <div style="flex: 1;">
      <p>
        {{ formLanguage === 'ar'
          ? 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… ÙƒÙ†Øµ Ø¥Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ. Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø±.'
          : 'You can add Terms and Conditions as text to your purchase order. The text will be automatically added at the end of the document when this option is enabled.'
        }}
      </p>
    </div>
  </div>

  <!-- âœ… Terms & Conditions Checkbox -->
  <div class="terms-checkbox-container">
    <div class="checkbox-wrapper">
      <input
        type="checkbox"
        id="includeTermsAndConditions"
        [(ngModel)]="poForm.includeTermsAndConditions"
        (change)="onTermsAndConditionsToggle()"
        class="checkbox-input"
      />
      <label for="includeTermsAndConditions" class="checkbox-label">
        <i class="bi bi-file-text"></i>
        <span>
          {{ formLanguage === 'ar'
            ? 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… Ø¥Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡'
            : 'Include Terms and Conditions with Purchase Order'
          }}
        </span>
      </label>
    </div>


  </div>

  <!-- âœ… Terms & Conditions Textarea (shows when checkbox is checked) -->
  <div class="terms-text-container" *ngIf="poForm.includeTermsAndConditions">
    <div class="terms-header">
      <label class="terms-label">
        <i class="bi bi-pencil-square"></i>
        {{ formLanguage === 'ar' ? 'Ù†Øµ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…' : 'Terms and Conditions Text' }}
      </label>
      <button
        type="button"
        class="btn-reset-terms"
        (click)="resetTermsToDefault()"
        [title]="formLanguage === 'ar' ? 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ' : 'Reset to default text'">
        <i class="bi bi-arrow-counterclockwise"></i>
        {{ formLanguage === 'ar' ? 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†' : 'Reset' }}
      </button>
    </div>

    <textarea
      id="termsAndConditionsText"
      [(ngModel)]="poForm.termsAndConditionsText"
      class="terms-textarea"
      rows="15"
      [placeholder]="formLanguage === 'ar'
        ? 'Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… Ù‡Ù†Ø§...'
        : 'Enter your Terms and Conditions text here...'"
    ></textarea>

    <div class="terms-footer-info">
      <i class="bi bi-lightbulb"></i>
      <span>
        {{ formLanguage === 'ar'
          ? 'ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ Ø­Ø³Ø¨ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ. Ø§Ù„Ù†Øµ Ø£Ø¹Ù„Ø§Ù‡ Ù‡Ùˆ Ù†Ù…ÙˆØ°Ø¬ Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙŠÙ…ÙƒÙ† ØªØ®ØµÙŠØµÙ‡.'
          : 'You can edit the text according to your needs. The text above is a default template that can be customized.'
        }}
      </span>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="form-navigation">
    <button class="btn-secondary btn-back" (click)="previousStep()" type="button">
      <i class="bi" [ngClass]="formLanguage === 'ar' ? 'bi-arrow-right' : 'bi-arrow-left'"></i>
      {{ formLanguage === 'ar' ? 'Ø§Ù„Ø³Ø§Ø¨Ù‚' : 'Back' }}
    </button>
  </div>

  <!-- Final Save Section -->
  <div class="final-save-section">
    <button
      class="btn-primary btn-save-final"
      (click)="savePO()"
      [disabled]="savingPO"
      type="button">
      <i class="bi bi-save"></i>
      {{ savingPO
        ? (formLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'Saving...')
        : (formLanguage === 'ar' ? 'Ø­ÙØ¸ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡' : 'Save Purchase Order')
      }}
    </button>

    <p class="save-info-text">
      {{ formLanguage === 'ar'
        ? 'Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸.'
        : 'A PDF file will be generated automatically after saving.'
      }}
    </p>
  </div>
</div>
      </div>
    </div>
  </div>

  <!-- PDF GENERATION MODAL -->
  <div *ngIf="showPDFModal" class="modal-overlay" (click)="closePDFModal()">
    <div class="modal-content pdf-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-section">
          <i class="bi bi-file-earmark-pdf modal-icon"></i>
          <h2>{{ formLanguage === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF' : 'Generate PDF Document' }}</h2>
        </div>
        <button class="btn-close" (click)="closePDFModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="info-box">
          <i class="bi bi-info-circle"></i>
          <p>{{ formLanguage === 'ar'
            ? 'Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF Ù„Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù PDF Ø¥Ø¶Ø§ÙÙŠ Ø§Ø®ØªÙŠØ§Ø±ÙŠØ§Ù‹ Ù„ÙŠØªÙ… Ø¯Ù…Ø¬Ù‡ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨.'
            : 'A PDF document will be generated for this purchase order. You can optionally attach an additional PDF file to be merged with the order.'
          }}</p>
        </div>

        <div class="pdf-info-card">
          <div class="pdf-info-row">
            <span class="pdf-info-label">
              <i class="bi bi-hash"></i>
              {{ formLanguage === 'ar' ? 'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨' : 'PO Number' }}
            </span>
            <span class="pdf-info-value">{{ selectedPONumber }}</span>
          </div>
          <div class="pdf-info-row">
            <span class="pdf-info-label">
              <i class="bi bi-file-text"></i>
              {{ formLanguage === 'ar' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù' : 'File Name' }}
            </span>
            <span class="pdf-info-value">{{ getPDFFilename() }}</span>
          </div>
        </div>

        <div class="form-group">
          <label class="upload-label">
            <i class="bi bi-paperclip"></i>
            {{ formLanguage === 'ar' ? 'Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù PDF Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'Attach Additional PDF (Optional)' }}
          </label>

          <div class="file-upload-wrapper">
            <input
              type="file"
              id="pdf-attachment"
              accept=".pdf"
              (change)="onPDFFileSelected($event)"
              class="file-input"
            />
            <label for="pdf-attachment" class="file-upload-label">
              <i class="bi bi-cloud-upload"></i>
              <span>{{ formLanguage === 'ar' ? 'Ø§Ø®ØªØ± Ù…Ù„Ù PDF' : 'Choose PDF File' }}</span>
            </label>
          </div>

          <div *ngIf="pdfAttachment" class="file-selected">
            <i class="bi bi-check-circle-fill"></i>
            <span class="file-name">{{ pdfAttachment.name }}</span>
            <button class="btn-remove-file" (click)="removePDFAttachment()" type="button">
              <i class="bi bi-x"></i>
            </button>
          </div>

          <small class="help-text">
            <i class="bi bi-exclamation-circle"></i>
            {{ formLanguage === 'ar'
              ? 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª. Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨.'
              : 'Maximum file size: 10MB. The attached file will be merged with the order.'
            }}
          </small>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closePDFModal()" [disabled]="generatingPDF">
          <i class="bi bi-x-circle"></i>
          {{ formLanguage === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
        </button>
        <button
          class="btn-primary btn-generate"
          (click)="generatePDF()"
          [disabled]="generatingPDF">
          <i class="bi" [ngClass]="generatingPDF ? 'bi-arrow-clockwise spin' : 'bi-file-earmark-pdf'"></i>
          {{ generatingPDF
            ? (formLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...' : 'Generating...')
            : (formLanguage === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ PDF' : 'Generate PDF')
          }}
        </button>
      </div>
    </div>
  </div>

  <!-- INLINE CONFIRMATION MODAL -->
  <div *ngIf="showConfirmationModal" class="confirmation-overlay" (click)="cancelConfirmation()">
    <div class="confirmation-modal" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'" (click)="$event.stopPropagation()">
      <div class="modal-header danger">
        <div class="modal-icon">
          <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <h3 class="modal-title">{{ confirmationTitle }}</h3>
      </div>

      <div class="modal-body">
        <p class="modal-message">{{ confirmationMessage }}</p>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelConfirmation()">
          <i class="bi bi-x-circle"></i>
          {{ formLanguage === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
        </button>
        <button class="btn-confirm danger" (click)="confirmAction()">
          <i class="bi bi-check-circle"></i>
          {{ formLanguage === 'ar' ? 'Ø­Ø°Ù' : 'Delete' }}
        </button>
      </div>
    </div>
  </div>

<div *ngIf="showDuplicateModal" class="confirmation-overlay" (click)="closeDuplicateModal()">
  <div class="confirmation-modal" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'" (click)="$event.stopPropagation()">
    <div class="modal-header warning">
      <div class="modal-icon">
        <i class="bi bi-files"></i>
      </div>
      <h3 class="modal-title">{{ formLanguage === 'ar' ? 'Ù†Ø³Ø® Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡' : 'Duplicate Purchase Order' }}</h3>
    </div>

    <div class="modal-body">
      <p class="modal-message">
        {{ formLanguage === 'ar'
          ? 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡'
          : 'Do you want to duplicate Purchase Order'
        }}
        <strong>{{ poToDuplicate?.poNumber }}</strong>ØŸ
        <br><br>
        <span style="color: #d97706; font-weight: 500;">
          {{ formLanguage === 'ar'
            ? 'Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ Ø¨Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.'
            : 'A new purchase order will be created with the same data that you can modify.'
          }}
        </span>
      </p>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeDuplicateModal()">
        <i class="bi bi-x-circle"></i>
        {{ formLanguage === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
      </button>
      <button class="btn-confirm" (click)="confirmDuplicate()">
        <i class="bi bi-files"></i>
        {{ formLanguage === 'ar' ? 'Ù†Ø³Ø®' : 'Duplicate' }}
      </button>
    </div>
  </div>
</div>
<!-- SHARE MODAL WITH EMAIL SELECTION -->
<div *ngIf="showShareModal" class="confirmation-overlay" (click)="closeShareModal()">
  <div class="confirmation-modal share-modal-improved" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'" (click)="$event.stopPropagation()">
    
    <!-- Fixed Header -->
    <div class="modal-header-fixed info">
      <button class="close-btn-fixed" (click)="closeShareModal()">
        <i class="bi bi-x-lg"></i>
      </button>
      
      <div class="modal-icon">
        <i class="bi bi-envelope-fill"></i>
      </div>
      
      <h3 class="modal-title">
        {{ formLanguage === 'ar' ? 'Ù…Ø´Ø§Ø±ÙƒØ© Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ' : 'Share Purchase Order via Email' }}
      </h3>
      
      <p class="modal-subtitle">
        {{ formLanguage === 'ar' 
          ? 'Ø§Ø®ØªØ± Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ Ø£ÙƒØ«Ø± Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯ Ù…Ø®ØµØµ'
          : 'Select one or more emails or enter a custom email'
        }}
      </p>
    </div>

    <!-- Scrollable Body -->
    <div class="modal-body-scrollable">
      
      <!-- PO Info Badge -->
      <div class="receipt-info-badge">
        <i class="bi bi-file-earmark-text-fill"></i>
        <span>{{ formLanguage === 'ar' ? 'Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡:' : 'Purchase Order:' }}</span>
        <strong>{{ sharePONumber }}</strong>
      </div>

      <!-- Email Selection Group -->
      <div class="email-selection-group">
        <label class="section-label">
          <i class="bi bi-at"></i>
          {{ formLanguage === 'ar' ? 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†' : 'Select Recipients' }}
        </label>

        <!-- Static Email 1 -->
        <label class="email-option">
          <input 
            type="checkbox" 
            [(ngModel)]="emailSelections.email1"
            [disabled]="sendingEmail"
          />
          <div class="email-option-content">
            <span class="checkbox-custom">
              <i class="bi bi-check"></i>
            </span>
            <div class="email-info">
              <i class="bi bi-envelope"></i>
              <span class="email-text">{{ staticEmails.email1 }}</span>
            </div>
          </div>
        </label>

        <!-- Static Email 2 -->
        <label class="email-option">
          <input 
            type="checkbox" 
            [(ngModel)]="emailSelections.email2"
            [disabled]="sendingEmail"
          />
          <div class="email-option-content">
            <span class="checkbox-custom">
              <i class="bi bi-check"></i>
            </span>
            <div class="email-info">
              <i class="bi bi-envelope"></i>
              <span class="email-text">{{ staticEmails.email2 }}</span>
            </div>
          </div>
        </label>

        <!-- Custom Email Option -->
        <label class="email-option">
          <input 
            type="checkbox" 
            [(ngModel)]="emailSelections.custom"
            [disabled]="sendingEmail"
          />
          <div class="email-option-content">
            <span class="checkbox-custom">
              <i class="bi bi-check"></i>
            </span>
            <div class="email-info">
              <i class="bi bi-pencil-fill"></i>
              <span class="email-text">{{ formLanguage === 'ar' ? 'Ø¨Ø±ÙŠØ¯ Ù…Ø®ØµØµ' : 'Custom Email' }}</span>
            </div>
          </div>
        </label>
      </div>

      <!-- Custom Email Input -->
      <div class="custom-email-input-wrapper" *ngIf="emailSelections.custom">
        <label class="input-label">
          <i class="bi bi-pencil-square"></i>
          {{ formLanguage === 'ar' ? 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø®ØµØµ' : 'Custom Email Address' }}
        </label>
        <input
          type="email"
          [(ngModel)]="customEmail"
          placeholder="example@domain.com"
          class="form-control-email"
          [disabled]="sendingEmail"
        />
        <small class="help-text" *ngIf="customEmail && !isValidEmail(customEmail)">
          <i class="bi bi-exclamation-circle"></i>
          {{ formLanguage === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­' : 'Please enter a valid email address' }}
        </small>
      </div>

      <!-- Selected Emails Preview -->
      <div class="selected-emails-preview" *ngIf="getSelectedEmailsList().length > 0">
        <div class="preview-header">
          <i class="bi bi-send-check-fill"></i>
          <span>{{ formLanguage === 'ar' ? 'Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰:' : 'Will be sent to:' }}</span>
          <span class="email-count">{{ getSelectedEmailsList().length }}</span>
        </div>
        <div class="email-chips">
          <span class="email-chip" *ngFor="let email of getSelectedEmailsList()">
            <i class="bi bi-check-circle-fill"></i>
            {{ email }}
          </span>
        </div>
      </div>

    </div>

    <!-- Fixed Footer -->
    <div class="modal-footer-fixed">
      <button class="btn-cancel" (click)="closeShareModal()" [disabled]="sendingEmail">
        <i class="bi bi-x-circle"></i>
        {{ formLanguage === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
      </button>
      <button class="btn-confirm btn-send" (click)="sendEmailWithPDF()" [disabled]="sendingEmail || !isEmailValid()">
        <i class="bi" [ngClass]="sendingEmail ? 'bi-hourglass-split spin-icon' : 'bi-send-fill'"></i>
        {{ sendingEmail 
          ? (formLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...' : 'Sending...') 
          : (formLanguage === 'ar' ? 'Ø¥Ø±Ø³Ø§Ù„' : 'Send')
        }}
      </button>
    </div>

  </div>
</div>


</div>
