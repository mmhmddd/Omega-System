<!-- receipts.component.html - UPDATED WITH EMAIL SELECTION OPTIONS -->

<div class="receipts-container">

  <!-- TOAST NOTIFICATIONS CONTAINER -->
  <div class="toast-container" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'">
    <div
      *ngFor="let toast of toasts"
      class="toast"
      [class.toast-success]="toast.type === 'success'"
      [class.toast-error]="toast.type === 'error'"
      [class.toast-info]="toast.type === 'info'"
      [class.toast-warning]="toast.type === 'warning'">

      <div class="toast-icon">
        <i class="bi"
           [ngClass]="{
             'bi-check-circle-fill': toast.type === 'success',
             'bi-x-circle-fill': toast.type === 'error',
             'bi-info-circle-fill': toast.type === 'info',
             'bi-exclamation-triangle-fill': toast.type === 'warning'
           }"></i>
      </div>

      <div class="toast-content">
        <p class="toast-message">{{ toast.message }}</p>
      </div>

      <button class="toast-close" (click)="removeToast(toast.id)">
        <i class="bi bi-x"></i>
      </button>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div *ngIf="showSuccessModal" class="success-modal-overlay" (click)="closeSuccessModal()">
    <div class="success-modal" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'" (click)="$event.stopPropagation()">

      <!-- Header -->
      <div class="success-header">
        <button class="close-btn" (click)="closeSuccessModal()">
          <i class="bi bi-x-lg"></i>
        </button>

        <div class="success-icon-wrapper">
          <i class="bi bi-check-circle-fill"></i>
        </div>

        <h2>{{ formLanguage === 'ar' ? 'تم إنشاء الإشعار بنجاح' : 'Receipt Created Successfully' }}</h2>
      </div>

      <!-- Body -->
      <div class="success-body">

        <!-- PDF Info Box -->
        <div class="pdf-info-box">
          <i class="bi bi-file-earmark-pdf-fill"></i>
          <div class="pdf-details">
            <p class="pdf-filename">{{ successReceiptNumber }}.pdf</p>
            <p class="pdf-status">
              {{ formLanguage === 'ar' ? 'جاهز للعرض والتحميل' : 'Ready to view and download' }}
            </p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons action-buttons-4">
          <!-- View PDF -->
          <button class="action-btn btn-view" (click)="viewPDFFromSuccess()">
            <div class="btn-icon">
              <i class="bi bi-eye-fill"></i>
            </div>
            <span class="btn-label">
              {{ formLanguage === 'ar' ? 'عرض PDF' : 'View PDF' }}
            </span>
          </button>

          <!-- Print PDF -->
          <button class="action-btn btn-print" (click)="printPDFFromSuccess()">
            <div class="btn-icon">
              <i class="bi bi-printer-fill"></i>
            </div>
            <span class="btn-label">
              {{ formLanguage === 'ar' ? 'طباعة' : 'Print' }}
            </span>
          </button>

          <!-- Download PDF -->
          <button class="action-btn btn-download" (click)="downloadPDFFromSuccess()">
            <div class="btn-icon">
              <i class="bi bi-download"></i>
            </div>
            <span class="btn-label">
              {{ formLanguage === 'ar' ? 'تحميل' : 'Download' }}
            </span>
          </button>

          <!-- Share Button -->
          <button class="action-btn btn-share" (click)="shareFromSuccessModal()">
            <div class="btn-icon">
              <i class="bi bi-envelope-fill"></i>
            </div>
            <span class="btn-label">
              {{ formLanguage === 'ar' ? 'مشاركة' : 'Share' }}
            </span>
          </button>
        </div>

        <!-- Done Button -->
        <button class="done-button" (click)="doneSuccess()">
          <i class="bi bi-check-circle"></i>
          {{ formLanguage === 'ar' ? 'تم' : 'Done' }}
        </button>
      </div>

    </div>
  </div>

  <!-- LIST VIEW -->
  <div *ngIf="currentView === 'list'" class="list-view">
    <!-- Header -->
    <div class="page-header">
      <h1 class="page-title">{{ formLanguage === 'ar' ? 'إشعارات الاستلام' : 'Receipts' }}</h1>
      <div class="header-actions">
        <!-- Language Toggle -->
        <div class="language-toggle">
          <button
            type="button"
            class="lang-btn"
            [class.active]="formLanguage === 'ar'"
            (click)="toggleFormLanguage('ar')">
            <i class="bi bi-translate"></i>
            عربي
          </button>
          <button
            type="button"
            class="lang-btn"
            [class.active]="formLanguage === 'en'"
            (click)="toggleFormLanguage('en')">
            <i class="bi bi-translate"></i>
            English
          </button>
        </div>
        <button class="btn-primary" (click)="createReceipt()">
          <i class="bi bi-plus-lg"></i>
          {{ formLanguage === 'ar' ? 'إنشاء إشعار' : 'Create Receipt' }}
        </button>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter-section" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'">
      <div class="search-box main-search">
        <i class="bi bi-search"></i>
        <input
          type="text"
          [placeholder]="formLanguage === 'ar' ? 'بحث برقم الإشعار، إلى، المشروع ...' : 'Search by number, to, project ...'"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchChange()"
          (keyup.enter)="onSearch()"
        />
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table class="receipts-table">
        <thead>
          <tr>
            <th class="text-center">{{ formLanguage === 'ar' ? 'رقم الإشعار' : 'Receipt #' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'إلى' : 'To' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'التاريخ' : 'Date' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'رمز المشروع' : 'Project Code' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'منشئ' : 'Created By' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'الدور' : 'Role' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'الحالة' : 'Status' }}</th>
            <th class="text-center">{{ formLanguage === 'ar' ? 'الإجراءات' : 'Actions' }}</th>
          </tr>
        </thead>
        <tbody *ngIf="!loading && receipts.length > 0">
          <tr *ngFor="let receipt of receipts">
            <td class="receipt-number text-center">{{ receipt.receiptNumber }}</td>
            <td class="text-center">{{ receipt.to || '-' }}</td>
            <td class="text-center">{{ receipt.date }}</td>
            <td class="text-center">{{ receipt.projectCode || '-' }}</td>
            <td class="text-center">{{ getCreatorName(receipt) }}</td>
            <td class="text-center">
              <span class="role-badge" [ngClass]="getRoleClass(receipt.createdByRole)">
                {{ getRoleText(receipt.createdByRole) }}
              </span>
            </td>
            <td class="text-center">
              <span class="status-badge" [ngClass]="getStatusClass(receipt)">
                {{ getStatusText(receipt) }}
              </span>
            </td>
            <td class="actions-cell text-center">
              <button
                class="btn-icon btn-view"
                (click)="viewPDF(receipt)"
                [title]="formLanguage === 'ar' ? 'عرض PDF' : 'View PDF'">
                <i class="bi bi-eye"></i>
              </button>
              <button
                class="btn-icon btn-print"
                (click)="printReceiptPDF(receipt)"
                [title]="formLanguage === 'ar' ? 'طباعة' : 'Print'">
                <i class="bi bi-printer"></i>
              </button>
              <button
                class="btn-icon btn-download"
                (click)="downloadPDF(receipt)"
                [title]="formLanguage === 'ar' ? 'تحميل PDF' : 'Download PDF'">
                <i class="bi bi-download"></i>
              </button>
              <button
                class="btn-icon btn-share"
                (click)="openShareModal(receipt)"
                [title]="formLanguage === 'ar' ? 'مشاركة' : 'Share'">
                <i class="bi bi-envelope"></i>
              </button>
              <button
                class="btn-icon btn-duplicate"
                (click)="openDuplicateModal(receipt)"
                [title]="formLanguage === 'ar' ? 'نسخ وإعادة استخدام' : 'Duplicate & Reuse'">
                <i class="bi bi-files"></i>
              </button>
              <button
                class="btn-icon btn-edit"
                (click)="editReceipt(receipt)"
                [title]="formLanguage === 'ar' ? 'تعديل' : 'Edit'">
                <i class="bi bi-pencil"></i>
              </button>
              <button
                class="btn-icon btn-delete"
                (click)="showDeleteConfirmation(receipt)"
                [title]="formLanguage === 'ar' ? 'حذف' : 'Delete'">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
        <tbody *ngIf="loading">
          <tr>
            <td colspan="8" class="text-center loading-cell">
              <i class="bi bi-arrow-clockwise spin"></i> {{ formLanguage === 'ar' ? 'جاري التحميل...' : 'Loading...' }}
            </td>
          </tr>
        </tbody>
        <tbody *ngIf="!loading && receipts.length === 0">
          <tr>
            <td colspan="8" class="text-center empty-cell">
              {{ formLanguage === 'ar' ? 'لا توجد إشعارات' : 'No receipts found' }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button
        class="btn-page"
        [disabled]="currentPage === 1"
        (click)="goToPage(currentPage - 1)">
        <i class="bi bi-chevron-left"></i>
      </button>

      <span class="page-info">
        {{ formLanguage === 'ar' ? 'صفحة' : 'Page' }} {{ currentPage }} {{ formLanguage === 'ar' ? 'من' : 'of' }} {{ totalPages }}
      </span>

      <button
        class="btn-page"
        [disabled]="currentPage === totalPages"
        (click)="goToPage(currentPage + 1)">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- CREATE/EDIT VIEW -->
  <div
    *ngIf="currentView === 'create' || currentView === 'edit'"
    class="form-view"
    [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'">
    <!-- Header -->
    <div class="form-header">
      <h1 class="form-title">
        {{ currentView === 'create'
          ? (formLanguage === 'ar' ? 'إنشاء إشعار استلام' : 'Create Receipt')
          : (formLanguage === 'ar' ? 'تعديل إشعار استلام' : 'Edit Receipt')
        }}
      </h1>
      <div class="form-header-actions">
        <div class="form-actions">
          <button class="btn-secondary" (click)="backToList()">
            {{ formLanguage === 'ar' ? 'إلغاء' : 'Cancel' }}
          </button>
          <button
            class="btn-primary"
            (click)="saveReceipt()"
            [disabled]="savingReceipt">
            <i class="bi bi-save"></i>
            {{ savingReceipt
              ? (formLanguage === 'ar' ? 'جاري الحفظ...' : 'Saving...')
              : (formLanguage === 'ar' ? 'حفظ' : 'Save')
            }}
          </button>
        </div>
      </div>
    </div>

    <!-- Error Alert -->
    <div class="error-alert" *ngIf="formError">
      <i class="bi bi-exclamation-circle"></i>
      <span>{{ formError }}</span>
    </div>

    <!-- Form Content -->
    <div class="form-content">
      <!-- Sidebar Navigation -->
      <div class="form-sidebar">
        <button
          class="sidebar-step"
          [class.active]="currentStep === 'basic'"
          (click)="currentStep = 'basic'">
          {{ formLanguage === 'ar' ? 'المعلومات الأساسية' : 'Basic Info' }}
        </button>

        <button
          class="sidebar-step"
          [class.active]="currentStep === 'items'"
          (click)="currentStep = 'items'">
          <span>
            {{ formLanguage === 'ar' ? 'العناصر (اختياري)' : 'Items (Optional)' }}
          </span>
          <span class="item-count">{{ getItemsCount() }}</span>
        </button>

        <button
          class="sidebar-step"
          [class.active]="currentStep === 'options'"
          (click)="currentStep = 'options'">
          {{ formLanguage === 'ar' ? 'الشروط والأحكام' : 'Terms & Conditions' }}
        </button>
      </div>

      <!-- Form Fields -->
      <div class="form-fields">

        <!-- STEP 1: Basic Info - ALL OPTIONAL -->
        <div *ngIf="currentStep === 'basic'" class="step-content">
          <h2 class="step-title">
            {{ formLanguage === 'ar' ? 'المعلومات الأساسية (اختيارية)' : 'Basic Info (Optional)' }}
          </h2>

          <!-- Info Alert -->
          <div class="info-alert">
            <i class="bi bi-info-circle"></i>
            <div style="flex: 1;">
              <p>
                {{ formLanguage === 'ar'
                  ? 'جميع الحقول اختيارية. فقط الحقول المملوءة ستظهر في ملف PDF.'
                  : 'All fields are optional. Only filled fields will appear in the PDF.'
                }}
              </p>
            </div>
          </div>

          <!-- Date and Project Code Row -->
          <div class="form-row">
            <div class="form-group">
              <label>
                <i class="bi bi-calendar"></i>
                {{ formLanguage === 'ar' ? 'التاريخ' : 'Date' }}
              </label>
              <input
                type="date"
                [(ngModel)]="receiptForm.date"
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label>
                <i class="bi bi-bookmark"></i>
                {{ formLanguage === 'ar' ? 'رمز المشروع' : 'Project Code' }}
              </label>
              <input
                type="text"
                [(ngModel)]="receiptForm.projectCode"
                [placeholder]="formLanguage === 'ar' ? 'مثال: PRJ-2024-001' : 'e.g. PRJ-2024-001'"
                class="form-control"
              />
            </div>
          </div>

          <!-- To Field -->
          <div class="form-group">
            <label>
              <i class="bi bi-person"></i>
              {{ formLanguage === 'ar' ? 'إلى' : 'To' }}
            </label>
            <input
              type="text"
              [(ngModel)]="receiptForm.to"
              [placeholder]="formLanguage === 'ar' ? 'اسم الشركة أو الشخص' : 'Company or Person Name'"
              class="form-control"
            />
          </div>

          <!-- Address Field -->
          <div class="form-group">
            <label>
              <i class="bi bi-geo-alt"></i>
              {{ formLanguage === 'ar' ? 'العنوان' : 'Address' }}
            </label>
            <textarea
              [(ngModel)]="receiptForm.address"
              [placeholder]="formLanguage === 'ar' ? 'أدخل العنوان الكامل' : 'Enter full address'"
              class="form-control"
              rows="3"
            ></textarea>
          </div>

          <!-- Work Location and Attention Row -->
          <div class="form-row">
            <div class="form-group">
              <label>
                <i class="bi bi-pin-map"></i>
                {{ formLanguage === 'ar' ? 'موقع العمل' : 'Work Location' }}
              </label>
              <input
                type="text"
                [(ngModel)]="receiptForm.workLocation"
                [placeholder]="formLanguage === 'ar' ? 'موقع تنفيذ العمل' : 'Work execution location'"
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label>
                <i class="bi bi-person-badge"></i>
                {{ formLanguage === 'ar' ? 'عناية' : 'Attention' }}
              </label>
              <input
                type="text"
                [(ngModel)]="receiptForm.attention"
                [placeholder]="formLanguage === 'ar' ? 'اسم الشخص المعني' : 'Concerned person name'"
                class="form-control"
              />
            </div>
          </div>

          <!-- Vehicle Number Field -->
          <div class="form-group">
            <label>
              <i class="bi bi-truck"></i>
              {{ formLanguage === 'ar' ? 'رقم المركبة' : 'Vehicle Number' }}
            </label>
            <input
              type="text"
              [(ngModel)]="receiptForm.vehicleNumber"
              [placeholder]="formLanguage === 'ar' ? 'مثال: ABC-1234' : 'e.g. ABC-1234'"
              class="form-control"
            />
          </div>

          <!-- Additional Text Field -->
          <div class="form-group">
            <label>
              <i class="bi bi-file-text"></i>
              {{ formLanguage === 'ar' ? 'نص إضافي (اختياري)' : 'Additional Text (Optional)' }}
            </label>
            <textarea
              [(ngModel)]="receiptForm.additionalText"
              [placeholder]="formLanguage === 'ar' ? 'يرجى استلام ما تم ادراجه ادناه:' : 'Please receive what is listed below:'"
              class="form-control"
              rows="3"
            ></textarea>
          </div>

          <!-- Notes Field -->
          <div class="form-group">
            <label>
              <i class="bi bi-chat-left-text"></i>
              {{ formLanguage === 'ar' ? 'ملاحظات' : 'Notes' }}
            </label>
            <textarea
              [(ngModel)]="receiptForm.notes"
              [placeholder]="formLanguage === 'ar' ? 'ملاحظات إضافية' : 'Additional notes'"
              class="form-control"
              rows="3"
            ></textarea>
          </div>

          <!-- PDF Attachment Upload -->
          <div class="form-group">
            <label>
              <i class="bi bi-paperclip"></i>
              {{ formLanguage === 'ar' ? 'إرفاق ملف PDF (اختياري)' : 'Attach PDF File (Optional)' }}
            </label>

            <div class="file-upload-wrapper">
              <input
                type="file"
                id="form-pdf-attachment"
                accept=".pdf"
                (change)="onFormPdfAttachmentSelected($event)"
                class="file-input"
              />
              <label for="form-pdf-attachment" class="file-upload-label">
                <i class="bi bi-cloud-upload"></i>
                <span>{{ formLanguage === 'ar' ? 'اختر ملف PDF' : 'Choose PDF File' }}</span>
              </label>
            </div>

            <div *ngIf="formPdfAttachment" class="file-selected">
              <i class="bi bi-check-circle-fill"></i>
              <span class="file-name">{{ formPdfAttachment.name }}</span>
              <button class="btn-remove-file" (click)="removeFormPdfAttachment()" type="button">
                <i class="bi bi-x"></i>
              </button>
            </div>

            <small class="help-text">
              {{ formLanguage === 'ar'
                ? 'الحد الأقصى لحجم الملف: 10 ميجابايت. سيتم دمج الملف المرفق مع الإشعار.'
                : 'Maximum file size: 10MB. The attached file will be merged with the receipt.'
              }}
            </small>
          </div>

          <div class="form-navigation">
            <button class="btn-primary btn-next" (click)="nextStep()">
              {{ formLanguage === 'ar' ? 'التالي' : 'Next' }}
              <i class="bi" [ngClass]="formLanguage === 'ar' ? 'bi-arrow-left' : 'bi-arrow-right'"></i>
            </button>
          </div>
        </div>

        <!-- STEP 2: Items (OPTIONAL) -->
        <div *ngIf="currentStep === 'items'" class="step-content">
          <h2 class="step-title">
            {{ formLanguage === 'ar' ? 'عناصر الإشعار (اختياري)' : 'Receipt Items (Optional)' }}
            <span class="optional-badge">{{ formLanguage === 'ar' ? 'اختياري' : 'Optional' }}</span>
          </h2>

          <!-- Info Alert -->
          <div class="info-alert">
            <i class="bi bi-info-circle"></i>
            <div style="flex: 1;">
              <p>
                {{ formLanguage === 'ar'
                  ? 'إضافة العناصر اختيارية. إذا لم تقم بإضافة أي عناصر، فلن يظهر الجدول في ملف PDF.'
                  : 'Adding items is optional. If you don\'t add any items, the table won\'t appear in the PDF.'
                }}
              </p>
            </div>
          </div>

          <div class="items-section">
            <div class="items-body" *ngIf="receiptForm.items.length > 0">
              <ng-container *ngFor="let item of receiptForm.items; let i = index">
                <div class="item-card">
                  <div class="item-card-header">
                    <span class="item-number">{{ formLanguage === 'ar' ? 'عنصر' : 'Item' }} #{{ i + 1 }}</span>
                    <button class="btn-remove" (click)="removeItem(i)" type="button">
                      <i class="bi bi-trash"></i>
                      {{ formLanguage === 'ar' ? 'حذف' : 'Delete' }}
                    </button>
                  </div>

                  <div class="item-card-body">
                    <!-- Quantity -->
                    <div class="item-field">
                      <label class="field-label">
                        {{ formLanguage === 'ar' ? 'الكمية' : 'Quantity' }}
                      </label>
                      <input
                        type="text"
                        [(ngModel)]="item.quantity"
                        class="item-input"
                        [placeholder]="formLanguage === 'ar' ? 'العدد' : 'Qty'"
                      />
                    </div>

                    <!-- Description -->
                    <div class="item-field">
                      <label class="field-label">
                        {{ formLanguage === 'ar' ? 'الوصف' : 'Description' }}
                      </label>
                      <input
                        type="text"
                        [(ngModel)]="item.description"
                        class="item-input"
                        [placeholder]="formLanguage === 'ar' ? 'الوصف' : 'Description'"
                      />
                    </div>

                    <!-- Element -->
                    <div class="item-field">
                      <label class="field-label">
                        {{ formLanguage === 'ar' ? 'العنصر' : 'Element' }}
                      </label>
                      <input
                        type="text"
                        [(ngModel)]="item.element"
                        class="item-input"
                        [placeholder]="formLanguage === 'ar' ? 'العنصر' : 'Element'"
                      />
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>

            <!-- Empty State -->
            <div class="items-empty" *ngIf="receiptForm.items.length === 0">
              <i class="bi bi-inbox" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
              <p style="margin: 0; color: #64748b;">
                {{ formLanguage === 'ar' ? 'لم يتم إضافة عناصر. يمكنك إضافة عناصر أو تخطي هذه الخطوة.' : 'No items added. You can add items or skip this step.' }}
              </p>
            </div>

            <button class="btn-add-item" (click)="addItem()" type="button">
              <i class="bi bi-plus-lg"></i>
              {{ formLanguage === 'ar' ? 'إضافة عنصر' : 'Add Item' }}
            </button>
          </div>

          <div class="form-navigation">
            <button class="btn-secondary btn-back" (click)="previousStep()" type="button">
              <i class="bi" [ngClass]="formLanguage === 'ar' ? 'bi-arrow-right' : 'bi-arrow-left'"></i>
              {{ formLanguage === 'ar' ? 'السابق' : 'Back' }}
            </button>
            <button class="btn-primary btn-next" (click)="nextStep()">
              {{ formLanguage === 'ar' ? 'التالي' : 'Next' }}
              <i class="bi" [ngClass]="formLanguage === 'ar' ? 'bi-arrow-left' : 'bi-arrow-right'"></i>
            </button>
          </div>
        </div>

        <!-- STEP 3: Terms & Conditions -->
        <div *ngIf="currentStep === 'options'" class="step-content">
          <h2 class="step-title">
            {{ formLanguage === 'ar' ? 'الشروط والأحكام' : 'Terms & Conditions' }}
          </h2>

          <div class="info-alert">
            <i class="bi bi-info-circle"></i>
            <div style="flex: 1;">
              <p>
                {{ formLanguage === 'ar'
                  ? 'يمكنك اختيار إضافة الشروط والأحكام إلى الإشعار الخاص بك. سيتم إضافتها في نهاية المستند.'
                  : 'You can choose to include terms and conditions with your receipt. They will be added at the end of the document.'
                }}
              </p>
            </div>
          </div>

          <div class="static-pdf-option">
            <div class="checkbox-container">
              <input
                type="checkbox"
                id="includeStaticFile"
                [(ngModel)]="receiptForm.includeStaticFile"
                class="checkbox-input"
              />
              <label for="includeStaticFile" class="checkbox-label">
                <span class="checkbox-custom">
                  <i class="bi bi-check"></i>
                </span>
                <span class="checkbox-text">
                  <i class="bi bi-file-earmark-text"></i>
                  {{ formLanguage === 'ar'
                    ? 'إضافة الشروط والأحكام إلى الإشعار'
                    : 'Include terms and conditions with receipt'
                  }}
                </span>
              </label>
            </div>

            <small class="help-text">
              {{ formLanguage === 'ar'
                ? 'عند تفعيل هذا الخيار، سيتم إضافة صفحة الشروط والأحكام إلى نهاية الإشعار الخاص بك.'
                : 'When enabled, the terms and conditions page will be appended to the end of your receipt.'
              }}
            </small>
          </div>

          <div class="form-navigation">
            <button class="btn-secondary btn-back" (click)="previousStep()" type="button">
              <i class="bi" [ngClass]="formLanguage === 'ar' ? 'bi-arrow-right' : 'bi-arrow-left'"></i>
              {{ formLanguage === 'ar' ? 'السابق' : 'Back' }}
            </button>
          </div>

          <!-- Final Save Section -->
          <div class="final-save-section">
            <button
              class="btn-primary btn-save-final"
              (click)="saveReceipt()"
              [disabled]="savingReceipt">
              <i class="bi bi-save"></i>
              {{ savingReceipt
                ? (formLanguage === 'ar' ? 'جاري الحفظ...' : 'Saving...')
                : (formLanguage === 'ar' ? 'حفظ الإشعار' : 'Save Receipt')
              }}
            </button>
            <p class="save-info-text">
              {{ formLanguage === 'ar'
                ? 'سيتم إنشاء ملف PDF تلقائياً بعد الحفظ'
                : 'A PDF file will be generated automatically after saving'
              }}{{ receiptForm.includeStaticFile ? (formLanguage === 'ar' ? ' مع الشروط والأحكام.' : ' with terms and conditions.') : '.' }}
            </p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- INLINE CONFIRMATION MODAL (DELETE) -->
  <div *ngIf="showConfirmationModal" class="confirmation-overlay" (click)="cancelConfirmation()">
    <div class="confirmation-modal" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'" (click)="$event.stopPropagation()">
      <div class="modal-header danger">
        <div class="modal-icon">
          <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <h3 class="modal-title">{{ confirmationTitle }}</h3>
      </div>

      <div class="modal-body">
        <p class="modal-message">{{ confirmationMessage }}</p>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="cancelConfirmation()">
          <i class="bi bi-x-circle"></i>
          {{ formLanguage === 'ar' ? 'إلغاء' : 'Cancel' }}
        </button>
        <button class="btn-confirm danger" (click)="confirmAction()">
          <i class="bi bi-check-circle"></i>
          {{ formLanguage === 'ar' ? 'حذف' : 'Delete' }}
        </button>
      </div>
    </div>
  </div>

  <!-- DUPLICATE CONFIRMATION MODAL -->
  <div *ngIf="showDuplicateModal" class="confirmation-overlay" (click)="closeDuplicateModal()">
    <div class="confirmation-modal" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'" (click)="$event.stopPropagation()">
      <div class="modal-header warning">
        <div class="modal-icon">
          <i class="bi bi-files"></i>
        </div>
        <h3 class="modal-title">{{ formLanguage === 'ar' ? 'نسخ الإشعار' : 'Duplicate Receipt' }}</h3>
      </div>

      <div class="modal-body">
        <p class="modal-message">
          {{ formLanguage === 'ar'
            ? 'هل تريد نسخ بيانات الإشعار'
            : 'Do you want to duplicate receipt'
          }}
          <strong>{{ receiptToDuplicate?.receiptNumber }}</strong>؟
          <br><br>
          <span style="color: #d97706; font-weight: 500;">
            {{ formLanguage === 'ar'
              ? 'سيتم إنشاء إشعار جديد بنفس البيانات مع إمكانية التعديل.'
              : 'A new receipt will be created with the same data that you can modify.'
            }}
          </span>
        </p>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeDuplicateModal()">
          <i class="bi bi-x-circle"></i>
          {{ formLanguage === 'ar' ? 'إلغاء' : 'Cancel' }}
        </button>
        <button class="btn-confirm" (click)="confirmDuplicate()">
          <i class="bi bi-files"></i>
          {{ formLanguage === 'ar' ? 'نسخ' : 'Duplicate' }}
        </button>
      </div>
    </div>
  </div>

<!-- IMPROVED SHARE MODAL WITH PROPER SCROLLING AND PADDING -->

<!-- IMPROVED SHARE MODAL WITH PROPER SCROLLING AND PADDING -->

<div *ngIf="showShareModal" class="confirmation-overlay" (click)="closeShareModal()">
  <div class="confirmation-modal share-modal-improved" [attr.dir]="formLanguage === 'ar' ? 'rtl' : 'ltr'" (click)="$event.stopPropagation()">
    
    <!-- Fixed Header -->
    <div class="modal-header-fixed info">
      <button class="close-btn-fixed" (click)="closeShareModal()">
        <i class="bi bi-x-lg"></i>
      </button>
      
      <div class="modal-icon">
        <i class="bi bi-envelope-fill"></i>
      </div>
      
      <h3 class="modal-title">
        {{ formLanguage === 'ar' ? 'مشاركة الإشعار عبر البريد الإلكتروني' : 'Share Receipt via Email' }}
      </h3>
      
      <p class="modal-subtitle">
        {{ formLanguage === 'ar' 
          ? 'اختر بريد إلكتروني أو أكثر أو أدخل بريد مخصص'
          : 'Select one or more emails or enter a custom email'
        }}
      </p>
    </div>

    <!-- Scrollable Body -->
    <div class="modal-body-scrollable">
      
      <!-- Receipt Info Badge -->
      <div class="receipt-info-badge">
        <i class="bi bi-file-earmark-text-fill"></i>
        <span>{{ formLanguage === 'ar' ? 'الإشعار:' : 'Receipt:' }}</span>
        <strong>{{ shareReceiptNumber }}</strong>
      </div>

      <!-- Email Selection Group -->
      <div class="email-selection-group">
        <label class="section-label">
          <i class="bi bi-at"></i>
          {{ formLanguage === 'ar' ? 'اختر المستلمين' : 'Select Recipients' }}
        </label>

        <!-- Static Email 1 -->
        <label class="email-option">
          <input 
            type="checkbox" 
            [(ngModel)]="emailSelections.email1"
            [disabled]="sendingEmail"
          />
          <div class="email-option-content">
            <span class="checkbox-custom">
              <i class="bi bi-check"></i>
            </span>
            <div class="email-info">
              <i class="bi bi-envelope"></i>
              <span class="email-text">{{ staticEmails.email1 }}</span>
            </div>
          </div>
        </label>

        <!-- Static Email 2 -->
        <label class="email-option">
          <input 
            type="checkbox" 
            [(ngModel)]="emailSelections.email2"
            [disabled]="sendingEmail"
          />
          <div class="email-option-content">
            <span class="checkbox-custom">
              <i class="bi bi-check"></i>
            </span>
            <div class="email-info">
              <i class="bi bi-envelope"></i>
              <span class="email-text">{{ staticEmails.email2 }}</span>
            </div>
          </div>
        </label>

        <!-- Custom Email Option -->
        <label class="email-option">
          <input 
            type="checkbox" 
            [(ngModel)]="emailSelections.custom"
            [disabled]="sendingEmail"
          />
          <div class="email-option-content">
            <span class="checkbox-custom">
              <i class="bi bi-check"></i>
            </span>
            <div class="email-info">
              <i class="bi bi-pencil-fill"></i>
              <span class="email-text">{{ formLanguage === 'ar' ? 'بريد مخصص' : 'Custom Email' }}</span>
            </div>
          </div>
        </label>
      </div>

      <!-- Custom Email Input (shown only when custom checkbox is checked) -->
      <div class="custom-email-input-wrapper" *ngIf="emailSelections.custom">
        <label class="input-label">
          <i class="bi bi-pencil-square"></i>
          {{ formLanguage === 'ar' ? 'البريد الإلكتروني المخصص' : 'Custom Email Address' }}
        </label>
        <input
          type="email"
          [(ngModel)]="customEmail"
          placeholder="example@domain.com"
          class="form-control-email"
          [disabled]="sendingEmail"
        />
        <small class="help-text" *ngIf="customEmail && !isValidEmail(customEmail)">
          <i class="bi bi-exclamation-circle"></i>
          {{ formLanguage === 'ar' ? 'يرجى إدخال بريد إلكتروني صحيح' : 'Please enter a valid email address' }}
        </small>
      </div>

      <!-- Selected Emails Preview -->
      <div class="selected-emails-preview" *ngIf="getSelectedEmailsList().length > 0">
        <div class="preview-header">
          <i class="bi bi-send-check-fill"></i>
          <span>{{ formLanguage === 'ar' ? 'سيتم الإرسال إلى:' : 'Will be sent to:' }}</span>
          <span class="email-count">{{ getSelectedEmailsList().length }}</span>
        </div>
        <div class="email-chips">
          <span class="email-chip" *ngFor="let email of getSelectedEmailsList()">
            <i class="bi bi-check-circle-fill"></i>
            {{ email }}
          </span>
        </div>
      </div>

    </div>

    <!-- Fixed Footer -->
    <div class="modal-footer-fixed">
      <button class="btn-cancel" (click)="closeShareModal()" [disabled]="sendingEmail">
        <i class="bi bi-x-circle"></i>
        {{ formLanguage === 'ar' ? 'إلغاء' : 'Cancel' }}
      </button>
      <button class="btn-confirm btn-send" (click)="sendEmailWithPDF()" [disabled]="sendingEmail || !isEmailValid()">
        <i class="bi" [ngClass]="sendingEmail ? 'bi-hourglass-split spin-icon' : 'bi-send-fill'"></i>
        {{ sendingEmail 
          ? (formLanguage === 'ar' ? 'جاري الإرسال...' : 'Sending...') 
          : (formLanguage === 'ar' ? 'إرسال' : 'Send')
        }}
      </button>
    </div>

  </div>
</div>

</div>